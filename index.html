<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plus Pack – Produktionsstop</title>
<style>
:root{
  --brand:#0b5fa4;      /* Plus Pack blå */
  --bg:#f7f9fc;
  --panel:#ffffff;
  --muted:#64748b;
  --text:#0f172a;
  --ok:#16a34a;
  --danger:#dc2626;
  --divider:#e5e7eb;
  --accent:#3b82f6;     /* markeringsfarve for Årsag */
  --accent2:#10b981;    /* markeringsfarve for Uddybning */
}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.brand{background:var(--brand);color:#fff;padding:10px 16px;font-weight:700}
.tabs{display:flex;gap:6px;background:#fff;border-bottom:1px solid var(--divider);padding:6px 8px;align-items:center}
.tab{border:0;background:transparent;padding:10px 14px;border-radius:8px 8px 0 0;cursor:pointer;font-weight:700}
.tab.active{background:#fff;box-shadow:0 -1px 0 0 var(--divider),0 2px 0 #fff inset}
.status{margin-left:auto;display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--divider);padding:6px 10px;border-radius:999px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--divider);border-radius:12px;padding:14px;margin-bottom:12px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 160px;gap:10px}
.field{display:grid;gap:6px}
label{font-size:12px;color:var(--muted)}
input,select,textarea{border:1px solid var(--divider);border-radius:8px;padding:8px 10px}
textarea{min-height:80px}
.btn{border:1px solid var(--divider);background:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn-stop{color:#991b1b;border-color:#f2aaaa}
.btn-start{color:#065f46;border-color:#a6e3b9}
.muted{color:var(--muted)}
.pill{padding:2px 8px;border:1px solid #d8e0eb;border-radius:999px;background:#fff;font-size:12px}
.right{text-align:right}

/* ====== Modal ====== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
.overlay.open{display:flex}
.modal{background:#fff;border:1px solid var(--divider);border-radius:14px;max-width:920px;width:96vw;box-shadow:0 30px 80px rgba(0,0,0,.25)}
.modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--divider)}
.modal-b{padding:12px 14px}
.modal-f{padding:12px 14px;border-top:1px solid var(--divider);display:flex;gap:8px;justify-content:flex-end;align-items:center}

/* ====== Chips (ny, mere intuitiv) ====== */
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{display:inline-flex;align-items:center;gap:10px;border:1px solid #d8e0eb;background:#f2f6fb;padding:10px 12px;border-radius:999px;font-size:13px;cursor:pointer;transition:transform .04s ease, box-shadow .15s ease, border-color .15s ease, background-color .15s ease}
.chip input{width:16px;height:16px}
.chip .txt{white-space:nowrap}
.chip .badge{font-size:11px;border:1px solid #d8e0eb;background:#fff;border-radius:999px;padding:2px 6px}
.chip:hover{box-shadow:0 1px 0 rgba(0,0,0,.02),0 2px 10px rgba(0,0,0,.06)}
.chip:active{transform:scale(.99)}

/* Valgt ÅRSAG -> brand/blå */
.chip-radio.selected{background:#e8f1ff;border-color:var(--accent)}
.chip-radio.selected .txt{color:#0b3d91;font-weight:700}
.chip-radio input:focus{outline:2px solid var(--accent)}

/* Valgt UDDYBNING -> grøn */
.chip-check.selected{background:#ecfdf5;border-color:var(--accent2)}
.chip-check.selected .txt{color:#065f46;font-weight:700}
.chip-check input:focus{outline:2px solid var(--accent2)}

.scroll{max-height:180px;overflow:auto;border:1px dashed #d8e0eb;background:#fff;padding:10px;border-radius:12px}
.reason-title{font-size:12px;color:var(--muted);margin:8px 0 6px}

/* Små grafer */
.bars{display:flex;flex-direction:column;gap:6px}
.bar-row{display:flex;align-items:center;gap:8px}
.bar-label{min-width:120px;max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bar{flex:1;background:#eef2f7;border:1px solid #d8e0eb;height:12px;border-radius:999px;overflow:hidden}
.bar>div{height:100%;background:var(--brand);width:0%}
.bar-val{min-width:80px;text-align:right;font-variant-numeric:tabular-nums}

/* Søgefelt */
.search{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.search input{flex:1}
.search .pill{background:#f8fafc}
</style>
</head>
<body>
  <div class="brand">Plus Pack – Produktionsstop</div>

  <div class="tabs">
    <button class="tab active" id="tab-reg">Registrering</button>
    <button class="tab" id="tab-hist">Historik</button>
    <button class="tab" id="tab-share">Deling</button>
    <button class="tab" id="tab-settings">Indstillinger</button>
    <div class="status"><span class="dot" id="dot" style="background:var(--ok)"></span><span id="statxt">Kører</span></div>
  </div>

  <div class="container">
    <!-- REG -->
    <section id="view-reg">
      <div class="card">
        <div class="grid">
          <div class="field">
            <label>Handling</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <button class="btn btn-stop" id="btn-stop">STOP</button>
              <button class="btn btn-start" id="btn-start" disabled>START</button>
            </div>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px">
          <div class="field">
            <label>Linje / Maskine</label>
            <select id="line">
              <option value="">— Vælg maskine —</option>
              <option>L10 75 t Rhodes special presse</option>
              <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
              <option disabled>L12 30 t Flexo C30 S15  INAKTIV</option>
              <option>L13 Press Beutler PD 40</option>
              <option>L14 50 t Flexo C50 S20 presse</option>
              <option>L15 30 t Flexo C30 S15 presse</option>
              <option>L16 40 t Schuler PNH 40/250 presse</option>
              <option>L17 30 t Flexo C30 S15 presse</option>
              <option>L20 50 t Bliss 50F MKII presse</option>
              <option>L22 50 t Bliss 50F MKII presse</option>
              <option>L23 45 t Bliss 21½ presse</option>
              <option>L24 30 t Flexo C30 S15</option>
              <option>L25 30 t Flexo C30 X presse</option>
              <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
              <option>L27 45 t Bliss 21½ presse</option>
              <option>L28 50 t Flexo presse</option>
              <option>L29 30 t Flexo C30 presse</option>
              <option>L30 ny presse 2012</option>
              <option>L33 50 t Bliss 50F MKII presse</option>
              <option>L34 50 t Bliss 50F MKII presse</option>
              <option>L35 30 t Flexo C30 S15 presse</option>
              <option>L36 30 t Flexo C30 S15 presse Picop</option>
              <option>L40 50 t Flexo C50 S20 presse</option>
              <option>L41 L37, 50 t Bliss 50F MKII presse</option>
              <option>L42 Press Beutler PD 40 alu spez638</option>
              <option>L43 Press Beutler PD 40 alu spez637</option>
              <option>L80 Choko-kapsler</option>
              <option>L81 Lys-manchetter</option>
              <option>L82 Lys-manchetter</option>
            </select>
          </div>
          <div class="field">
            <label>Operatør (valgfri)</label>
            <input id="operator" type="text" placeholder="Navn/initialer"/>
          </div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="btn-clear-line" type="button">Ryd linje/navn</button></div>
        </div>

        <div class="grid3" style="margin-top:8px">
          <div class="field"><label>Ordre nr. (krævet)</label><input id="orderNo" type="text"/></div>
          <div class="field"><label>Vare nr. (krævet)</label><input id="itemNo" type="text"/></div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="btn-clear-order" type="button">Ryd ordre</button></div>
        </div>

        <p class="muted" id="liveTimer">—</p>
      </div>

      <div class="card" id="stats-card" style="margin-top:10px">
        <h3 style="margin:0 0 8px">Stop-statistik</h3>
        <div class="muted" style="margin-bottom:8px">Alle registreringer i denne browser.</div>
        <div class="grid">
          <div>
            <h4 style="margin:0 0 6px">Hyppighed (antal pr. årsag)</h4>
            <div id="freqBars" class="bars"></div>
          </div>
          <div>
            <h4 style="margin:0 0 6px">Varighed (sum pr. årsag)</h4>
            <div id="durBars" class="bars"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- HIST -->
    <section id="view-hist" style="display:none">
      <div class="card">
        <div class="usage-wrap" style="margin-bottom:10px">
          <strong>Poster:</strong><span id="countPosts">0</span>
          <strong style="margin-left:12px">Plads:</strong><span id="usageTxt">0%</span>
          <div class="usage"><div id="usageFill"></div></div>
          <button class="btn" id="btn-archive">Arkivér & nulstil</button>
        </div>
        <div style="overflow:auto;max-height:60vh;border:1px solid var(--divider);border-radius:10px">
          <table>
            <thead><tr>
              <th>Start</th><th>Slut</th><th>Varighed</th><th>Linje</th><th>Ordre</th><th>Vare</th><th>Kode</th><th>Uddybning</th><th>Kommentar</th><th>Operatør</th><th class="right">Handling</th>
            </tr></thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SHARE -->
    <section id="view-share" style="display:none">
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-csv">Eksporter CSV</button>
          <button class="btn" id="btn-json">Kopiér JSON</button>
          <button class="btn" id="btn-email">Send til mail</button>
          <button class="btn" id="btn-clear-log">Nulstil log</button>
        </div>
        <p class="muted">Data gemmes lokalt i browseren (localStorage).</p>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" style="display:none">
      <div class="card">
        <div class="grid">
          <div class="field"><label>Standard-modtager</label><input id="defTo" type="email" placeholder="M.masiewicz@pluspack.com"/></div>
          <div class="field"><label>Brandfarve</label><input id="brandColor" type="text" placeholder="#0b5fa4"/></div>
        </div>
        <div style="margin-top:8px"><button class="btn" id="btn-save-settings">Gem indstillinger</button></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Årsager</h3>
        <div class="grid">
          <div class="field"><label>Kode (fx PRES)</label><input id="causeCode" type="text" placeholder="KODE"/></div>
          <div class="field"><label>Navn/label</label><input id="causeLabel" type="text" placeholder="Beskrivelse"/></div>
        </div>
        <div class="field" style="margin-top:8px"><label>Uddybning (chips, kommasepareret)</label><input id="causeChips" type="text" placeholder="fx Rensning, Sikkerhed, Opsætning"/></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-add-cause">Tilføj årsag</button>
          <button class="btn" id="btn-reset-causes">Nulstil til standard</button>
        </div>
        <div id="causeList" style="margin-top:8px"></div>
      </div>
    </section>
  </div>

  <!-- STOP MODAL -->
  <div class="overlay" id="ov-stop">
    <div class="modal">
      <div class="modal-h"><strong>Registrér stop</strong><button class="btn" id="stop-close">Luk</button></div>
      <div class="modal-b">
        <div class="grid">
          <div>
            <div class="search">
              <input id="reasonSearch" type="search" placeholder="Søg i årsager… (skriv for at filtrere)"/>
              <span class="pill">Top 10 vises først</span>
            </div>
            <div id="reasonButtons">
              <div class="chips" id="reasonTop"></div>
              <div class="reason-title" id="reasonMoreLabel" style="display:none">Flere årsager</div>
              <div class="chips scroll" id="reasonMore" style="display:none"></div>
            </div>
          </div>
          <div>
            <label>Uddybning</label>
            <div class="chips" id="reasonChips"></div>
          </div>
        </div>
        <div class="field" style="margin-top:8px"><label>Andet (uddybning)</label><input id="other" type="text"/></div>
        <div class="field"><label>Kommentar</label><textarea id="comment"></textarea></div>
        <p id="stopValidation" class="muted"></p>
      </div>
      <div class="modal-f">
        <button class="btn" id="stop-cancel">Annuller</button>
        <button class="btn btn-stop" id="stop-confirm">Bekræft stop</button>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="overlay" id="ov-edit">
    <div class="modal">
      <div class="modal-h"><strong>Redigér</strong><button class="btn" id="edit-close">Luk</button></div>
      <div class="modal-b">
        <input type="hidden" id="edit-id"/>
        <div class="grid"><div class="field"><label>Start</label><input id="edit-start" type="datetime-local"/></div><div class="field"><label>Slut</label><input id="edit-end" type="datetime-local"/></div></div>
        <div class="grid"><div class="field"><label>Linje</label><select id="edit-line"></select></div><div class="field"><label>Operatør</label><input id="edit-operator" type="text"/></div></div>
        <div class="grid"><div class="field"><label>Ordre</label><input id="edit-order" type="text"/></div><div class="field"><label>Vare</label><input id="edit-item" type="text"/></div></div>
        <div class="grid"><div class="field"><label>Årsagskode</label><select id="edit-reason"></select></div><div class="field"><label>Uddybning</label><div class="chips" id="edit-chips"></div></div></div>
        <div class="field"><label>Andet</label><input id="edit-other" type="text"/></div>
        <div class="field"><label>Kommentar</label><textarea id="edit-comment"></textarea></div>
      </div>
      <div class="modal-f"><button class="btn" id="edit-cancel">Annuller</button> <button class="btn" id="edit-save">Gem</button></div>
    </div>
  </div>

  <!-- EMAIL MODAL -->
  <div class="overlay" id="ov-email">
    <div class="modal">
      <div class="modal-h"><strong>Send til e-mail</strong><button class="btn" id="email-close">Luk</button></div>
      <div class="modal-b">
        <div class="grid"><div class="field"><label>Til</label><input id="email-to" type="email"/></div><div class="field"><label>Cc</label><input id="email-cc" type="text"/></div></div>
        <div class="grid"><div class="field"><label>Emne</label><input id="email-subj" type="text"/></div><div class="field"><label>Vedhæft</label><select id="email-attach"><option value="csv">CSV</option><option value="json">JSON</option></select></div></div>
        <div class="field"><label>Besked</label><textarea id="email-body">Se vedhæftede produktionsstop-log.</textarea></div>
      </div>
      <div class="modal-f"><button class="btn" id="email-cancel">Annuller</button> <button class="btn" id="email-send">Send</button></div>
    </div>
  </div>

<script>
/* ===== Polyfills ===== */
if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,'');};}
if(!Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement,fromIndex){var O=Object(this),len=O.length>>>0;if(len===0)return-1;var n=+fromIndex||0;if(n>=len)return-1;var k=(n>=0)?n:Math.max(len-Math.abs(n),0);for(;k<len;k++){if(k in O&&O[k]===searchElement)return k;}return-1;};}

/* ===== Helpers ===== */
function byId(id){return document.getElementById(id);}
function addClass(el,c){if(!el)return;if(el.className.indexOf(c)===-1)el.className+=(el.className?' ':'')+c;}
function remClass(el,c){if(!el)return;var a=el.className.split(' '),i=a.indexOf(c);if(i>-1){a.splice(i,1);el.className=a.join(' ');}}
function show(el){if(el)el.style.display='';}
function hide(el){if(el)el.style.display='none';}
function openOv(id){addClass(byId(id),'open');}
function closeOv(id){remClass(byId(id),'open');}
function pad(n){return(n<10?'0':'')+n;}
function fmtDate(d){var dt=(d instanceof Date)?d:new Date(d);try{return dt.toLocaleString('da-DK');}catch(e){return dt.toString();}}
function fmtDur(ms){var s=Math.floor((ms||0)/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60);return h+':'+m+':'+ss;}
function uuid(){return 'id-'+(new Date().getTime())+'-'+Math.floor(Math.random()*1e6);}
function bytesLen(str){return unescape(encodeURIComponent(str||'')).length;}

/* ===== Storage ===== */
var STORAGE='produktionsstop.events.v1';
var SETTINGS='produktionsstop.settings.v1';
var DEFAULT_REASONS=[
  {code:'PRES', label:'Presse', chips:['Rensning','Smøring','Opsætning']},
  {code:'VAERK',label:'Værktøj',chips:['Skift','Slid','Defekt']},
  {code:'STAK' ,label:'Stakker', chips:['Fejl','Opsamler','Andet']},
  {code:'FOLIE',label:'Manglende folie',chips:['Påfyld','Bestilling']},
  {code:'ORDRE',label:'Manglende ordre',chips:['Afventer','Uklar ordre']},
  {code:'ANDET',label:'Andet',chips:['Sikkerhed','Rengøring']}
];
function loadEvents(){try{return JSON.parse(localStorage.getItem(STORAGE))||[];}catch(e){return[];}}
function saveEvents(x){localStorage.setItem(STORAGE,JSON.stringify(x));}
function loadSettings(){try{return JSON.parse(localStorage.getItem(SETTINGS))||{};}catch(e){return{};}}
function saveSettings(x){localStorage.setItem(SETTINGS,JSON.stringify(x));}
function getAllReasons(){var s=loadSettings(),custom=s.customCauses||[],map={},out=[],i;for(i=0;i<DEFAULT_REASONS.length;i++){map[DEFAULT_REASONS[i].code]=DEFAULT_REASONS[i];}for(i=0;i<custom.length;i++){map[custom[i].code]={code:custom[i].code,label:custom[i].label,chips:custom[i].chips||[]};}for(var k in map){if(map.hasOwnProperty(k))out.push(map[k]);}return out;}
function getReasonByCode(code){var list=getAllReasons();for(var i=0;i<list.length;i++){if(list[i].code===code)return list[i];}return null;}

/* ===== Elements ===== */
var els={
  tabReg:byId('tab-reg'), tabHist:byId('tab-hist'), tabShare:byId('tab-share'), tabSettings:byId('tab-settings'),
  viewReg:byId('view-reg'), viewHist:byId('view-hist'), viewShare:byId('view-share'), viewSettings:byId('view-settings'),
  dot:byId('dot'), statxt:byId('statxt'),
  btnStop:byId('btn-stop'), btnStart:byId('btn-start'),
  line:byId('line'), operator:byId('operator'), btnClearLine:byId('btn-clear-line'),
  orderNo:byId('orderNo'), itemNo:byId('itemNo'), btnClearOrder:byId('btn-clear-order'),
  liveTimer:byId('liveTimer'), tableBody:byId('tbl-body'),
  countPosts:byId('countPosts'), usageTxt:byId('usageTxt'), usageFill:byId('usageFill'), btnArchive:byId('btn-archive'),
  ovStop:byId('ov-stop'), stopClose:byId('stop-close'), stopCancel:byId('stop-cancel'), stopConfirm:byId('stop-confirm'),
  reasonButtons:byId('reasonButtons'), reasonTop:byId('reasonTop'), reasonMore:byId('reasonMore'), reasonMoreLabel:byId('reasonMoreLabel'),
  reasonChips:byId('reasonChips'), other:byId('other'), comment:byId('comment'), stopValidation:byId('stopValidation'), reasonSearch:byId('reasonSearch'),
  ovEdit:byId('ov-edit'), editClose:byId('edit-close'), editCancel:byId('edit-cancel'), editSave:byId('edit-save'),
  editId:byId('edit-id'), editStart:byId('edit-start'), editEnd:byId('edit-end'),
  editLine:byId('edit-line'), editOperator:byId('edit-operator'), editOrder:byId('edit-order'), editItem:byId('edit-item'),
  editReason:byId('edit-reason'), editChips:byId('edit-chips'), editOther:byId('edit-other'), editComment:byId('edit-comment'),
  btnCsv:byId('btn-csv'), btnJson:byId('btn-json'), btnEmail:byId('btn-email'), btnClearLog:byId('btn-clear-log'),
  ovEmail:byId('ov-email'), emailClose:byId('email-close'), emailCancel:byId('email-cancel'), emailSend:byId('email-send'),
  emailTo:byId('email-to'), emailCc:byId('email-cc'), emailSubj:byId('email-subj'), emailBody:byId('email-body'), emailAttach:byId('email-attach'),
  defTo:byId('defTo'), brandColor:byId('brandColor'), btnSaveSettings:byId('btn-save-settings'),
  causeCode:byId('causeCode'), causeLabel:byId('causeLabel'), causeChips:byId('causeChips'), btnAddCause:byId('btn-add-cause'),
  btnResetCauses:byId('btn-reset-causes'), causeList:byId('causeList')
};

/* ===== Tabs ===== */
function setActiveTab(which){
  var tabs=[els.tabReg,els.tabHist,els.tabShare,els.tabSettings],i;
  for(i=0;i<tabs.length;i++){remClass(tabs[i],'active');}
  addClass(which,'active');
  hide(els.viewReg); hide(els.viewHist); hide(els.viewShare); hide(els.viewSettings);
  if(which===els.tabReg)show(els.viewReg);
  else if(which===els.tabHist)show(els.viewHist);
  else if(which===els.tabShare)show(els.viewShare);
  else show(els.viewSettings);
}
els.tabReg.onclick=function(){setActiveTab(els.tabReg);};
els.tabHist.onclick=function(){setActiveTab(els.tabHist);};
els.tabShare.onclick=function(){setActiveTab(els.tabShare);};
els.tabSettings.onclick=function(){setActiveTab(els.tabSettings);};

/* ===== Status/timer ===== */
var isStopped=false, stopStartISO=null, stopMeta=null, timer=null;
function setStatus(st){isStopped=st;els.btnStop.disabled=st;els.btnStart.disabled=!st;els.dot.style.background=st?'var(--danger)':'var(--ok)';els.statxt.innerHTML=st?'Stoppet':'Kører';els.liveTimer.innerHTML=st?'Stop varighed: 00:00:00':'—';}
function tick(){if(!isStopped)return;var ms=(new Date().getTime())-(new Date(stopStartISO).getTime());els.liveTimer.innerHTML='Stop varighed: '+fmtDur(ms);}

/* ===== Kapacitet ===== */
var QUOTA=5*1024*1024;
function updateUsage(){var used=0;try{used+=bytesLen(localStorage.getItem(STORAGE)||'');}catch(e){}try{used+=bytesLen(localStorage.getItem(SETTINGS)||'');}catch(e){}var pct=Math.min(100,Math.round((used/QUOTA)*100));els.usageTxt.innerHTML=pct+'% ('+Math.round(used/1024)+' KB af 5120 KB)';els.usageFill.style.width=pct+'%';els.usageTxt.className=(pct>=90)?'danger':(pct>=80)?'warn':'';}

/* ===== Grafer ===== */
function renderBars(containerId,rows,maxVal,isDuration){var el=byId(containerId);if(!el)return;if(!rows||!rows.length){el.innerHTML='<div class="muted">Ingen data endnu</div>';return;}var html='',i;for(i=0;i<rows.length;i++){var p=maxVal>0?Math.round((rows[i].v/maxVal)*100):0;var valTxt=isDuration?fmtDur(rows[i].v):(rows[i].v+' stk');html+='<div class="bar-row"><div class="bar-label">'+rows[i].label+'</div><div class="bar"><div style="width:'+p+'%"></div></div><div class="bar-val">'+valTxt+'</div></div>';}el.innerHTML=html;}
function computeStats(){var rows=loadEvents(),map={},i,r,code,label;for(i=0;i<rows.length;i++){r=rows[i];if(!r||!r.reason)continue;code=r.reason.code||'ANDET';label=(r.reason.code||'')+' — '+(r.reason.label||r.reason.code||'');if(!map[code])map[code]={label:label,count:0,dur:0};map[code].count+=1;map[code].dur+=(r.durationMs||0);}var arr=[],k;for(k in map){if(map.hasOwnProperty(k))arr.push({code:k,label:map[k].label,count:map[k].count,dur:map[k].dur});}return arr;}
function renderCharts(){var stats=computeStats(),i;var freq=stats.slice().sort(function(a,b){return b.count-a.count;});var maxC=0;for(i=0;i<freq.length;i++){if(freq[i].count>maxC)maxC=freq[i].count;}var freqRows=[];for(i=0;i<freq.length;i++){freqRows.push({label:freq[i].label,v:freq[i].count});}renderBars('freqBars',freqRows,maxC,false);var dur=stats.slice().sort(function(a,b){return b.dur-a.dur;});var maxD=0;for(i=0;i<dur.length;i++){if(dur[i].dur>maxD)maxD=dur[i].dur;}var durRows=[];for(i=0;i<dur.length;i++){durRows.push({label:dur[i].label,v:dur[i].dur});}renderBars('durBars',durRows,maxD,true);}

/* ===== Tabel ===== */
function renderTable(){var rows=loadEvents().sort(function(a,b){return (new Date(b.start))-(new Date(a.start));});var html='',i;for(i=0;i<rows.length;i++){var ev=rows[i];html+='<tr>'
+'<td><span class="muted">'+fmtDate(ev.start)+'</span></td>'
+'<td><span class="muted">'+(ev.end?fmtDate(ev.end):'—')+'</span></td>'
+'<td>'+(ev.durationMs?fmtDur(ev.durationMs):'—')+'</td>'
+'<td>'+(ev.line||'')+'</td>'
+'<td>'+(ev.orderNo||'')+'</td>'
+'<td>'+(ev.itemNo||'')+'</td>'
+'<td><span class="pill">'+((ev.reason&&ev.reason.code)||'')+'</span> '+((ev.reason&&ev.reason.label)||'')+'</td>'
+'<td>'+((ev.detailChips||[]).join(', '))+' '+(ev.other||'')+'</td>'
+'<td>'+(ev.comment||'')+'</td>'
+'<td>'+(ev.operator||'')+'</td>'
+'<td class="right"><button class="btn" data-action="edit" data-id="'+ev.id+'">Redigér</button> <button class="btn btn-stop" data-action="delete" data-id="'+ev.id+'">Slet</button></td>'
+'</tr>'; }
els.tableBody.innerHTML=html;els.countPosts.innerHTML=''+rows.length;updateUsage();renderCharts();}

/* ===== Persist ===== */
function hasRequired(){return (els.orderNo.value||'').trim()&&(els.itemNo.value||'').trim();}
function syncLine(){var s=loadSettings(),v=(els.line.value||'');s.line=(v.indexOf('INAKTIV')>-1)?'':v;s.operator=(els.operator.value||'');saveSettings(s);}
function syncOrder(){var s=loadSettings();s.orderNo=(els.orderNo.value||'');s.itemNo=(els.itemNo.value||'');saveSettings(s);}

/* ===== Export ===== */
function makeCsv(rows){function repl(s){return String(s||'').split(';').join(',');}function clean(s){return String(s||'').replace(/\n/g,' ');}var header=['id','start','slut','varighed_ms','varighed_hhmmss','linje','ordre','vare','kode','kode_label','uddybning','andet','kommentar','operatør'].join(';');var body=[];for(var i=0;i<rows.length;i++){var r=rows[i];var code=(r.reason&&r.reason.code)||'';var label=(r.reason&&r.reason.label)||'';body.push([r.id,r.start,r.end,r.durationMs,fmtDur(r.durationMs||0),repl(r.line),repl(r.orderNo),repl(r.itemNo),code,label,repl((r.detailChips||[]).join('|')),repl(r.other),repl(clean(r.comment)),repl(r.operator)].join(';'));}return header+'\n'+body.join('\n');}
function download(filename,text){var blob=new Blob([text],{type:'text/plain;charset=utf-8;'});if(window.navigator&&window.navigator.msSaveBlob){window.navigator.msSaveBlob(blob,filename);}else{var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);setTimeout(function(){URL.revokeObjectURL(url);},500);}}

/* ===== STOP modal (årsager/uddybning) ===== */
function selectedChips(){var inputs=els.reasonChips.getElementsByTagName('input'),arr=[],i;for(i=0;i<inputs.length;i++){if(inputs[i].checked)arr.push(inputs[i].value);}return arr;}
function getReasonFreq(){var s=loadSettings();return s.reasonFreq||{};}
function bumpReasonFreq(code){var s=loadSettings();if(!s.reasonFreq)s.reasonFreq={};s.reasonFreq[code]=(s.reasonFreq[code]||0)+1;saveSettings(s);}

function chipHtmlRadio(code,label,count){
  var badge=count?(' <span class="badge">'+count+'</span>'):'';
  return '<label class="chip chip-radio"><input type="radio" name="reasonRadio" value="'+code+'"><span class="txt">'+code+' — '+label+'</span>'+badge+'</label>';
}
function chipHtmlCheck(txt,checked){
  return '<label class="chip chip-check'+(checked?' selected':'')+'"><input type="checkbox"'+(checked?' checked':'')+' value="'+txt+'"><span class="txt">'+txt+'</span></label>';
}

function renderChipsByCode(code){
  var r=getReasonByCode(code)||{chips:[]}, chips=r.chips||[], html='',i;
  for(i=0;i<chips.length;i++){ html+=chipHtmlCheck(chips[i], false); }
  els.reasonChips.innerHTML=html;
}

function markSelectedChipStates(){
  // Marker valgt årsag
  var radios=els.reasonButtons.querySelectorAll('input[name="reasonRadio"]');
  for(var i=0;i<radios.length;i++){
    var lbl=radios[i].parentNode;
    if(lbl && lbl.className.indexOf('chip-radio')>-1){
      if(radios[i].checked) addClass(lbl,'selected'); else remClass(lbl,'selected');
    }
  }
  // Marker valgte uddybninger
  var checks=els.reasonChips.querySelectorAll('input[type="checkbox"]');
  for(var j=0;j<checks.length;j++){
    var lbl2=checks[j].parentNode;
    if(lbl2 && lbl2.className.indexOf('chip-check')>-1){
      if(checks[j].checked) addClass(lbl2,'selected'); else remClass(lbl2,'selected');
    }
  }
}

function renderReasonButtons(){
  var list=getAllReasons(),freq=getReasonFreq();
  list.sort(function(a,b){var fa=freq[a.code]||0,fb=freq[b.code]||0;if(fb!==fa)return fb-fa;return a.label.localeCompare(b.label);});
  var TOP_N=10, topHtml='', moreHtml='';
  for(var i=0;i<list.length;i++){
    var f=(freq[list[i].code]||0);
    var chip=chipHtmlRadio(list[i].code, list[i].label, f);
    if(i<TOP_N) topHtml+=chip; else moreHtml+=chip;
  }
  els.reasonTop.innerHTML=topHtml;
  els.reasonMore.innerHTML=moreHtml;
  if(moreHtml){els.reasonMore.style.display='flex';els.reasonMoreLabel.style.display='block';}
  else{els.reasonMore.style.display='none';els.reasonMoreLabel.style.display='none';}
  var first=els.reasonButtons.querySelector('input[name="reasonRadio"]');
  if(first){ first.checked=true; renderChipsByCode(first.value); }
  markSelectedChipStates();
}

function filterReasons(q){
  q=(q||'').trim().toLowerCase();
  var labels=els.reasonButtons.querySelectorAll('.chip-radio');
  for(var i=0;i<labels.length;i++){
    var t=labels[i].innerText.toLowerCase();
    labels[i].style.display=(q && t.indexOf(q)===-1)?'none':'inline-flex';
  }
}

/* Delegation for klik + keyboard */
function onReasonAreaClick(e){
  var t=e.target||e.srcElement;
  if(t && t.name==='reasonRadio'){
    renderChipsByCode(t.value);
    markSelectedChipStates();
    els.stopValidation.innerHTML='';
  }
}
function onChipsClick(e){
  var t=e.target||e.srcElement;
  if(t && t.type==='checkbox'){
    // toggle class via markSelectedChipStates
    markSelectedChipStates();
  }
}

/* ===== STOP/START flow ===== */
els.btnStop.onclick=function(){openOv('ov-stop');renderReasonButtons();els.stopValidation.innerHTML='';};
els.stopClose.onclick=function(){closeOv('ov-stop');};
els.stopCancel.onclick=function(){closeOv('ov-stop');};
if(els.reasonButtons.addEventListener){els.reasonButtons.addEventListener('click',onReasonAreaClick,false);}
if(els.reasonChips.addEventListener){els.reasonChips.addEventListener('click',onChipsClick,false);}
els.reasonSearch.onkeyup=function(){filterReasons(this.value);};

els.stopConfirm.onclick=function(){
  if(!hasRequired()){els.stopValidation.innerHTML='Udfyld Ordre nr. og Vare nr. i hovedskærmen før du bekræfter.';return;}
  var radios=els.reasonButtons.querySelectorAll('input[name="reasonRadio"]'),code=null,i;
  for(i=0;i<radios.length;i++){if(radios[i].checked){code=radios[i].value;break;}}
  if(!code){var all=getAllReasons();code=(all[0]&&all[0].code)||'ANDET';}
  var reason=getReasonByCode(code)||{code:code,label:code};
  stopMeta={reason:{code:reason.code,label:reason.label},detailChips:selectedChips(),other:(els.other.value||'').trim(),comment:(els.comment.value||'').trim()};
  stopStartISO=new Date().toISOString();
  setStatus(true); if(timer)clearInterval(timer); timer=setInterval(tick,1000); tick();
  bumpReasonFreq(code);
  closeOv('ov-stop');
};

els.btnStart.onclick=function(){
  if(!isStopped)return;
  var end=new Date(),start=new Date(stopStartISO),duration=end-start;
  var rows=loadEvents();
  rows.push({id:uuid(),start:start.toISOString(),end:end.toISOString(),durationMs:duration,
    line:(els.line.value||''),operator:(els.operator.value||''),orderNo:(els.orderNo.value||''),itemNo:(els.itemNo.value||''),
    reason:stopMeta?stopMeta.reason:null,detailChips:stopMeta?stopMeta.detailChips:[],other:stopMeta?stopMeta.other:'',comment:stopMeta?stopMeta.comment:''});
  saveEvents(rows); renderTable();
  setStatus(false); stopStartISO=null; stopMeta=null; if(timer){clearInterval(timer);timer=null;}
  /* forbliv på Registrering */
};

/* ===== Historik knapper ===== */
els.tableBody.onclick=function(e){var t=e.target||e.srcElement;while(t&&t.tagName!=='BUTTON'&&t!==this){t=t.parentNode;}if(!t||t===this)return;var id=t.getAttribute('data-id');var act=t.getAttribute('data-action');var rows=loadEvents();if(act==='delete'){if(!confirm('Slet denne registrering?'))return;var out=[],i;for(i=0;i<rows.length;i++){if(rows[i].id!==id)out.push(rows[i]);}saveEvents(out);renderTable();}else if(act==='edit'){openEdit(id);}};

/* ===== Redigering ===== */
function fillMachineSelect(sel){sel.innerHTML='';var opts=byId('line').getElementsByTagName('option'),i;for(i=0;i<opts.length;i++){var o=document.createElement('option');o.text=opts[i].text;o.value=opts[i].value||opts[i].text;if(opts[i].disabled)o.disabled=true;sel.appendChild(o);}}
function toLocalInput(iso){if(!iso)return'';var d=new Date(iso);function p(n){return(n<10?'0':'')+n;}return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+'T'+p(d.getHours())+':'+p(d.getMinutes());}
function chipsHtml(chips,sel){var out='',i;for(i=0;i<chips.length;i++){var checked=(sel&&sel.indexOf(chips[i])>-1)?' checked':'';out+='<label class="chip chip-check'+(checked?' selected':'')+'"><input type="checkbox" value="'+chips[i]+'"'+checked+'><span class="txt">'+chips[i]+'</span></label>'; }return out;}
function openEdit(id){var rows=loadEvents(),i=-1,k;for(k=0;k<rows.length;k++){if(rows[k].id===id){i=k;break;}}if(i<0)return;var ev=rows[i];els.editId.value=ev.id;els.editStart.value=toLocalInput(ev.start);els.editEnd.value=toLocalInput(ev.end);fillMachineSelect(els.editLine);els.editLine.value=ev.line||'';els.editOperator.value=ev.operator||'';els.editOrder.value=ev.orderNo||'';els.editItem.value=ev.itemNo||'';var list=getAllReasons().slice().sort(function(a,b){return a.label.localeCompare(b.label);});els.editReason.innerHTML='';for(k=0;k<list.length;k++){var opt=document.createElement('option');opt.value=list[k].code;opt.text=list[k].code+' — '+list[k].label;els.editReason.appendChild(opt);}var curCode=(ev.reason&&ev.reason.code)||(list[0]&&list[0].code);els.editReason.value=curCode;var chips=(getReasonByCode(curCode)||{chips:[]}).chips||[];els.editChips.innerHTML=chipsHtml(chips, ev.detailChips||[]);els.editOther.value=ev.other||'';els.editComment.value=ev.comment||'';openOv('ov-edit');}
els.editReason.onchange=function(){var code=els.editReason.value;var chips=(getReasonByCode(code)||{chips:[]}).chips||[];els.editChips.innerHTML=chipsHtml(chips,[]);};
els.editClose.onclick=function(){closeOv('ov-edit');};
els.editCancel.onclick=function(){closeOv('ov-edit');};
els.editSave.onclick=function(){var id=els.editId.value;var rows=loadEvents(),i=-1,k;for(k=0;k<rows.length;k++){if(rows[k].id===id){i=k;break;}}if(i<0)return;var st=new Date(els.editStart.value),en=new Date(els.editEnd.value);if(isNaN(st)||isNaN(en)||en<st){alert('Ugyldig start/slut');return;}var code=els.editReason.value;var r=getReasonByCode(code)||{code:code,label:code};var chips=[],inputs=els.editChips.getElementsByTagName('input'),a;for(a=0;a<inputs.length;a++){if(inputs[a].checked)chips.push(inputs[a].value);}rows[i]={id:rows[i].id,start:st.toISOString(),end:en.toISOString(),durationMs:(en-st),line:els.editLine.value||'',operator:els.editOperator.value||'',orderNo:els.editOrder.value||'',itemNo:els.editItem.value||'',reason:{code:r.code,label:r.label},detailChips:chips,other:els.editOther.value||'',comment:els.editComment.value||''};saveEvents(rows);renderTable();closeOv('ov-edit');};

/* ===== Inputs ===== */
els.line.onchange=syncLine; els.operator.onkeyup=syncLine;
els.btnClearLine.onclick=function(){els.line.value='';els.operator.value='';syncLine();};
els.orderNo.onkeyup=syncOrder; els.itemNo.onkeyup=syncOrder;
els.btnClearOrder.onclick=function(){els.orderNo.value='';els.itemNo.value='';syncOrder();};

/* ===== Deling ===== */
els.btnCsv.onclick=function(){var csv=makeCsv(loadEvents());download('produktionsstop.csv',csv);};
els.btnJson.onclick=function(){var json=JSON.stringify(loadEvents(),null,2);try{if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(json);alert('JSON kopieret');}else{throw new Error('no clipboard');}}catch(e){prompt('Kopiér JSON:',json);}};
els.btnClearLog.onclick=function(){if(confirm('Slet hele loggen?')){saveEvents([]);renderTable();}};
els.btnArchive.onclick=function(){var rows=loadEvents();if(!rows.length){alert('Ingen data at arkivere.');return;}var d=new Date(),y=d.getFullYear(),m=pad(d.getMonth()+1),da=pad(d.getDate()),hh=pad(d.getHours()),mm=pad(d.getMinutes());var name='produktionsstop_'+y+m+da+'_'+hh+mm+'.csv';var csv=makeCsv(rows);download(name,csv);if(confirm('Log blev eksporteret. Vil du nulstille loggen nu?')){saveEvents([]);renderTable();}};

/* ===== Email ===== */
function defaultEmailSubject(){var line=(els.line.value||''),ord=(els.orderNo.value||'');var d=new Date();var date=d.toLocaleDateString?d.toLocaleDateString('da-DK'):(pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear());return 'Produktionsstop'+(line?' – '+line:'')+(ord?' – Ordre '+ord:'')+' – '+date;}
els.btnEmail.onclick=function(){var s=loadSettings();els.emailTo.value=s.defaultTo||'M.masiewicz@pluspack.com';els.emailCc.value='';els.emailSubj.value=defaultEmailSubject();els.emailBody.value='Se vedhæftede produktionsstop-log.';els.emailAttach.value='csv';openOv('ov-email');};
els.emailClose.onclick=function(){closeOv('ov-email');};
els.emailCancel.onclick=function(){closeOv('ov-email');};
els.emailSend.onclick=function(){var to=(els.emailTo.value||'').trim();if(!to){alert('Angiv modtager');return;}var attach=els.emailAttach.value;var rows=loadEvents();var filename=(attach==='csv')?'produktionsstop.csv':'produktionsstop.json';var content=(attach==='csv')?makeCsv(rows):JSON.stringify(rows,null,2);download(filename,content);var subj=(els.emailSubj.value||'');var body=(els.emailBody.value||'')+"\n\n(Husk at vedhæfte filen)";var cc=(els.emailCc.value||'');var href='mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body);if(cc)href+='&cc='+encodeURIComponent(cc);window.location.href=href;closeOv('ov-email');};

/* ===== Årsager – indstillinger ===== */
function renderCustomList(){var s=loadSettings(),list=s.customCauses||[];if(!list.length){els.causeList.innerHTML='<p class="muted">Ingen brugerdefinerede årsager endnu.</p>';return;}var html='<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Kode</th><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Label</th><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Chips</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Handling</th></tr></thead><tbody>';for(var i=0;i<list.length;i++){html+='<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">'+list[i].code+'</td><td style="padding:6px;border-bottom:1px solid #e5e7eb">'+list[i].label+'</td><td style="padding:6px;border-bottom:1px solid #e5e7eb">'+(list[i].chips||[]).join(', ')+'</td><td style="padding:6px;border-bottom:1px solid #e5e7eb" class="right"><button class="btn" data-del="'+list[i].code+'">Slet</button></td></tr>'; } html+='</tbody></table>'; els.causeList.innerHTML=html; var buttons=els.causeList.getElementsByTagName('button'),b;for(b=0;b<buttons.length;b++){buttons[b].onclick=function(){var code=this.getAttribute('data-del');var s=loadSettings(),arr=s.customCauses||[],out=[],k;for(k=0;k<arr.length;k++){if(arr[k].code!==code)out.push(arr[k]);}s.customCauses=out;saveSettings(s);renderCustomList();};}}
function bindAddCause(){function addCauseHandler(){var code=(els.causeCode.value||'').trim().toUpperCase();var label=(els.causeLabel.value||'').trim();var raw=(els.causeChips.value||'').split(','),chips=[],i;for(i=0;i<raw.length;i++){var t=raw[i].trim();if(t)chips.push(t);}if(!code||!label){alert('Udfyld både kode og label');return;}var all=getAllReasons();for(i=0;i<all.length;i++){if((all[i].code||'').toUpperCase()===code){alert('Koden findes allerede. Vælg en anden.');return;}}var s=loadSettings();if(!s.customCauses)s.customCauses=[];s.customCauses.push({code:code,label:label,chips:chips});saveSettings(s);els.causeCode.value='';els.causeLabel.value='';els.causeChips.value='';renderCustomList();if(els.ovStop && els.ovStop.className.indexOf('open')>-1){renderReasonButtons();}alert('Årsag tilføjet');} if(els.btnAddCause.addEventListener){els.btnAddCause.addEventListener('click',addCauseHandler,false);}els.btnAddCause.onclick=addCauseHandler;}
els.btnResetCauses.onclick=function(){if(confirm('Nulstil egne årsager og statistik?')){var s=loadSettings();s.customCauses=[];s.reasonFreq={};saveSettings(s);renderCustomList();alert('Årsager nulstillet.');}};

/* ===== Settings ===== */
function applyBrand(){var s=loadSettings();if(s.brandColor){document.documentElement.style.setProperty('--brand',s.brandColor);}els.defTo.value=s.defaultTo||'M.masiewicz@pluspack.com';els.brandColor.value=s.brandColor||'#0b5fa4';if(s.line){els.line.value=s.line;}els.operator.value=s.operator||'';els.orderNo.value=s.orderNo||'';els.itemNo.value=s.itemNo||'';}
els.btnSaveSettings.onclick=function(){var s=loadSettings();s.defaultTo=(els.defTo.value||'');s.brandColor=(els.brandColor.value||'');saveSettings(s);applyBrand();alert('Indstillinger gemt');};

/* ===== Init ===== */
function init(){setActiveTab(els.tabReg);setStatus(false);renderTable();applyBrand();renderCustomList();bindAddCause();}
window.onerror=function(msg,src,line,col){alert('JavaScript-fejl: '+msg+' (linje '+line+')');return false;};
init();
</script>
</body>
</html>
