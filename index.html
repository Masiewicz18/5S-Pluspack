<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plus Pack ‚Äì 5S Audit</title>
<style>
  :root{
    --bg:#f7fbff; --panel:#fff; --txt:#0f172a; --muted:#475569;
    --line:#e5eaf0; --chip:#eef6ff; --accent:#3b82f6; --accent2:#06b6d4;
    --ok:#16a34a; --mid:#f59e0b; --bad:#ef4444;
    --c-sort:#3b82f6; --c-set:#06b6d4; --c-shine:#10b981; --c-std:#f59e0b; --c-sus:#8b5cf6;
    --r-xl:18px; --r-lg:14px; --shadow:0 6px 20px rgba(2,6,23,.06);
    --overlay:rgba(2,6,23,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f4f8ff, #fff);color:var(--txt);font:15px/1.6 "Segoe UI",Roboto,system-ui,sans-serif}
  .wrap{max-width:1440px;margin:24px auto;padding:0 16px}
  .app{background:var(--panel);border:1px solid var(--line);border-radius:var(--r-xl);box-shadow:var(--shadow);overflow:hidden}

  /* Header */
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--line);background:#fff}
  .brand{display:flex;gap:10px;align-items:center}
  .dotlogo{width:14px;height:14px;border-radius:999px;background:linear-gradient(180deg,var(--accent2),var(--accent))}
  h1{margin:0;font-size:18px}
  .actions{display:flex;gap:10px;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--chip);font-size:12px}
  .statusDot{width:10px;height:10px;border-radius:999px;background:#a3a3a3}
  .btn{border:0;border-radius:10px;padding:9px 12px;cursor:pointer;font-weight:600}
  .btn.secondary{background:#f1f6ff}
  .btn.accent{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
  .btn.ok{background:#e8faf0;border:1px solid #b7e4c7}
  .btn.ghost{background:#fff;border:1px dashed var(--line)}
  .btn.danger{background:#fee2e2;border:1px solid #fecaca}

  /* Tabs */
  .tabs{display:flex;border-bottom:1px solid var(--line);background:#f8fafc}
  .tab{flex:1;text-align:center;padding:10px 12px;cursor:pointer;font-weight:600;background:transparent;border:none;outline:none;color:var(--muted)}
  .tab.active{color:var(--accent);border-bottom:3px solid var(--accent);background:#fff}
  .tab:hover{background:#f1f5f9}
  .tab-panel{display:block}

  /* Layout */
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:22px;padding:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .card{background:#fff;border:1px solid var(--line);border-radius:var(--r-lg);padding:16px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 12px;font-weight:700;font-size:16px}

  /* Generelt */
  .formRow{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:14px}
  @media (max-width:1100px){.formRow{grid-template-columns:repeat(2,minmax(220px,1fr))}}
  @media (max-width:720px){.formRow{grid-template-columns:1fr}}
  .field{display:flex;flex-direction:column}
  label{font-size:13px;color:var(--muted);margin:6px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.2);outline:0}
  input[type="date"]{min-width:0}
  textarea{min-height:96px}

  /* 5S blokke */
  .sblock{position:relative;border:1px solid var(--line);border-radius:12px;padding:14px;margin:14px 0;background:#fff}
  .sblock::before{content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:12px 0 0 12px;background:var(--col)}
  .srow{display:grid;grid-template-columns:180px 72px 1fr 170px;align-items:center;gap:12px}
  .title{font-weight:800}
  .bubble{width:48px;height:40px;display:grid;place-items:center;font-weight:800;border:1px solid var(--line);border-radius:10px;background:#f7faff}
  .step{display:flex;align-items:center;gap:6px}
  .step button{width:24px;height:24px;border:1px solid var(--line);background:#fff;border-radius:6px;font-weight:800;cursor:pointer}
  .sliderWrap{display:flex;align-items:center;gap:8px;width:100%}
  input[type="range"]{-webkit-appearance:none;appearance:none;flex:1;height:10px;border-radius:999px;background:#e6edf7}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid var(--accent);box-shadow:0 2px 8px rgba(2,6,23,.15)}
  .mini{font-size:11px;color:#94a3b8}
  .miniBar{height:6px;border-radius:999px;background:#e6edf7;margin-top:6px;overflow:hidden}
  .miniBar>span{display:block;height:100%;width:0;background:var(--accent);transition:width .2s}

  /* Score-overblik */
  .scoreCard{position:sticky;top:14px}
  .scoreList{display:flex;flex-direction:column;gap:10px}
  .sitem{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}
  .shead{display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .sbar{height:8px;background:#eef3fb;border-radius:999px;overflow:hidden;margin-top:6px}
  .sbar>span{display:block;height:100%;width:0}
  .sex{color:#6b7280;font-size:13px;margin-top:6px}
  .total{margin-top:12px;border:1px solid var(--line);background:#f1f7ff;border-radius:10px;padding:10px;text-align:center;font-weight:800}

  /* Kort-billeder (uden zoom) */
  .map-img{max-width:100%;height:auto;border:1px solid var(--line);border-radius:12px;display:block}

  /* Bekr√¶ftelses-modal */
  .modalOverlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modalOverlay.show{display:flex}
  .modalCard{max-width:520px;width:100%;background:#fff;border:1px solid var(--line);border-radius:var(--r-xl);box-shadow:0 20px 60px rgba(2,6,23,.25);overflow:hidden}
  .modalHead{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#f8fbff,#fff)}
  .modalIcon{display:grid;place-items:center;width:36px;height:36px;border-radius:10px;background:#fff5f5;border:1px solid #fecaca;font-weight:900;color:#b91c1c}
  .modalTitle{margin:0;font-weight:800;font-size:16px}
  .modalBody{padding:14px 16px;color:#334155}
  .modalBody strong{color:#b91c1c}
  .modalFoot{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line);background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <div class="app">
    <header>
      <div class="brand"><span class="dotlogo"></span><h1>Plus Pack <small style="color:#64748b">¬∑ 5S Audit</small></h1></div>
      <div class="actions">
        <button id="printBtn" class="btn secondary" type="button">üñ®Ô∏è Print</button>
        <span class="chip"><span id="statusDot" class="statusDot"></span><span id="statusTxt">Klar</span></span>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="audit">üìù Audit</button>
      <button class="tab" data-tab="map">üó∫Ô∏è Kort</button>
    </nav>

    <!-- AUDIT-PANEL -->
    <div id="auditPanel" class="tab-panel">
      <div class="grid">
        <!-- Venstre -->
        <div>
          <div class="card">
            <h3>Generelt</h3>
            <div class="formRow">
              <div class="field">
                <label for="dept">Afdeling</label>
                <select id="dept">
                  <option value="" disabled selected>V√¶lg‚Ä¶</option>
                  <option>V√¶rksted</option><option>Alu</option><option>FVL</option><option>RVL</option><option>Plast</option>
                </select>
              </div>
              <div class="field">
                <label for="name">Navn</label>
                <input id="name" placeholder="Dit navn"/>
              </div>
              <div class="field">
                <label for="date">Dato</label>
                <input id="date" type="date"/>
              </div>
            </div>
          </div>

          <div class="card" id="blocks"><h3>5S ‚Äì Score og observationer</h3></div>

          <div class="card">
            <h3>Observationer (liste)</h3>
            <table>
              <thead><tr><th style="width:180px">5S</th><th style="width:60%">Beskrivelse</th><th style="width:20%">Billeder</th><th style="width:20%">Handling</th></tr></thead>
              <tbody id="obsBody"><tr><td colspan="4" style="text-align:center;color:#64748b;padding:16px">Ingen observationer endnu.</td></tr></tbody>
            </table>
          </div>

          <div class="footer">
            <button id="saveBtn" class="btn" type="button">Gem kladde</button>
            <button id="clearBtn" class="btn secondary" type="button">Ryd</button>
            <button id="sendBtn" class="btn accent" type="button">Indsend</button>
          </div>
        </div>

        <!-- H√∏jre -->
        <aside class="card scoreCard">
          <h3>Score-overblik</h3>

          <!-- Radar-graf -->
          <canvas id="radar" style="width:100%;height:280px;"></canvas>

          <div id="scoreList" class="scoreList" style="margin-top:10px"></div>
          <div id="totalBox" class="total">Total: 0/25 (0%)</div>

          <div class="card" style="margin-top:10px">
            <b>Guide: Hvordan scorer du?</b>
            <ul style="margin:10px 0 0 18px;color:#4b5563;font-size:14px">
              <li><b>0</b> = Ikke p√• plads / ikke implementeret</li>
              <li><b>1‚Äì2</b> = P√•begyndt, uensartet, kr√¶ver tydelige forbedringer</li>
              <li><b>3</b> = OK niveau, f√∏lger standarder men med huller</li>
              <li><b>4</b> = God praksis, mindre afvigelser</li>
              <li><b>5</b> = Fremragende, stabilt og vedligeholdt niveau</li>
            </ul>
          </div>
        </aside>
      </div>
    </div>

    <!-- KORT-PANEL (zoom fjernet) -->
    <div id="mapPanel" class="tab-panel" style="display:none;">
      <div class="grid">
        <div class="card" style="grid-column:1 / -1;">
          <h3>5S Walk ‚Äì Kort</h3>

          <img src="./TEST.PNG" alt="5S Walk kort" class="map-img">
          <img src="./Locationer r√•vare lagret.PNG" alt="Lokation r√•vare" class="map-img" style="margin-top:16px;">

          <p style="color:var(--muted);margin-top:8px">
            F√∏lg ruten fra <strong>Start</strong> ‚Üí <strong>Slut</strong>. Brug kortet som fast sekvens til dine 5S-observationer.
          </p>
          <div class="card" style="margin-top:10px;background:#f8fafc">
            <b>Tip:</b> Not√©r observationer i r√¶kkef√∏lgen 1‚Äì9 mens du g√•r ruten for at undg√• huller og dobbeltarbejde.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Global datalist til s√∏gbar "Hvor" -->
<datalist id="locOptions">
  <option value="Port Alu RV"></option>
  <option value="Port Alu-Plast RV"></option>
  <option value="Port Plast RV"></option>
  <option value="Port ved modtagelsen"></option>
  <option value="Gang N RV"></option>
  <option value="Gang M RV"></option>
  <option value="Gang KL RV"></option>
  <option value="Gang U RV"></option>
  <option value="Gang GH RV"></option>
  <option value="Gang EF RV"></option>
  <option value="Gang CD RV"></option>
  <option value="Gang AB RV"></option>
  <option value="Udpak RV"></option>
  <option value="Dock RV"></option>
</datalist>

<!-- Bekr√¶ftelses-modal -->
<div id="confirmModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmDesc">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalIcon">!</div>
      <h3 id="confirmTitle" class="modalTitle">Indsend 5S Audit?</h3>
    </div>
    <div class="modalBody" id="confirmDesc">
      <p><strong>Bem√¶rk:</strong> N√•r du indsender, bliver auditten oprettet og observationer sendt til SharePoint.</p>
      <p>Er du helt sikker p√•, at alt er korrekt udfyldt?</p>
    </div>
    <div class="modalFoot">
      <button id="confirmCancel" class="btn secondary" type="button">Annull√©r</button>
      <button id="confirmOk" class="btn accent" type="button">Ja, indsend</button>
    </div>
  </div>
</div>

<script>
'use strict';

/* ===== Power Automate endpoints (dine) ===== */
const ENDPOINT_AUDIT = "https://default430cd76f558540b4b6d4f372acf579.16.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c125172796c54698b8f2846f97ff4e0e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=pSjeXn9i7gLQ0cQZuHVsRV6R5iJdqe2v9_VnjhAjfoc";
const ENDPOINT_OBS   = "https://default430cd76f558540b4b6d4f372acf579.16.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/02058f832d784053acb059c0124e3e40/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8GsT2zUZm5FRT6gpsfIKsFw4po8uY53HwaCDhlscahc";

/* ===== Helpers ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const getCSS=(v)=>getComputedStyle(document.documentElement).getPropertyValue(v).trim();
const today = ()=> new Date().toISOString().slice(0,10);
const escapeHTML=(s)=>(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const short=(s)=> (s||'').trim().replace(/\s+/g,' ').slice(0,220)+((s||'').length>220?'‚Ä¶':'');
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
function toast(t){ $('#statusTxt').textContent=t; setTimeout(updateTotals,1500); }

/* ===== Komprimering ===== */
function canvasToJpeg(img, maxSidePx, quality){
  const scale = Math.min(1, maxSidePx / Math.max(img.width, img.height));
  const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
  const c = document.createElement('canvas'); c.width = w; c.height = h;
  const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
  return c.toDataURL('image/jpeg', quality);
}
async function compressToTargetKB(file, {
  startMaxSide=1600, startQuality=0.75, minQuality=0.5, minSide=1024, targetKB=350
} = {}){
  const dataUrl = await new Promise((res, rej) => {
    const fr = new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);
  });
  const img = await new Promise((res, rej) => { const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=dataUrl; });
  let q=startQuality, side=startMaxSide, out=canvasToJpeg(img, side, q);
  const sizeKB = (d)=>Math.round((d.length - d.indexOf(',') - 1)*3/4/1024);
  let kb=sizeKB(out), guard=0;
  while(kb>targetKB && guard++<8){
    if(q>minQuality) q=Math.max(minQuality, q-0.1);
    else if(side>minSide) side=Math.max(minSide, Math.round(side*0.85));
    else break;
    out=canvasToJpeg(img, side, q); kb=sizeKB(out);
  }
  return out;
}
async function getUpToNCompressed(files, maxN=5, targetKB=350){
  const arr=Array.from(files||[]); if(arr.length>maxN) alert(`Der kan kun tilf√∏jes op til ${maxN} billeder. De f√∏rste ${maxN} bruges.`);
  const use=arr.slice(0,maxN); const out=[];
  for(const f of use) out.push(await compressToTargetKB(f,{targetKB}));
  return out;
}

/* ===== Data (danske labels) ===== */
const S5=[
  {key:'sort',  name:'Sort√©r',       color:getCSS('--c-sort'), tip:'Fjern overfl√∏dige ting. Kun det n√∏dvendige i arbejdsomr√•det.'},
  {key:'set',   name:'Systematis√©r', color:getCSS('--c-set'),  tip:'Alt har en fast plads, tydelig m√¶rkning og let adgang.'},
  {key:'shine', name:'Reng√∏ring',    color:getCSS('--c-shine'),tip:'Daglig reng√∏ring, udstyr og gulv uden snavs/olie.'},
  {key:'std',   name:'Standardis√©r', color:getCSS('--c-std'),  tip:'Faste standarder/visualer f√∏lges ens i hele omr√•det.'},
  {key:'sus',   name:'Fasthold',     color:getCSS('--c-sus'),  tip:'Rutiner efterleves, audit foretages, l√∏bende forbedring.'},
];
const SCORES=Object.fromEntries(S5.map(s=>[s.key,0]));
let OBS=[];
const SKEY='pluspack.5s.audit.v14';
let IS_RESTORING = false;

/* ===== MIGRATION fra v12/v13 ===== */
const PREV_KEYS = ['pluspack.5s.audit.v13', 'pluspack.5s.audit.v12'];
function migrateDraftsIfNeeded() {
  if (localStorage.getItem(SKEY)) return;
  for (const oldKey of PREV_KEYS) {
    const raw = localStorage.getItem(oldKey);
    if (!raw) continue;
    try {
      const d = JSON.parse(raw);
      const meta = d?.meta || {};
      const scores = d?.scores || {};
      let observations = Array.isArray(d?.observations) ? d.observations : [];
      observations = observations.map(o => ({
        id: o?.id ?? (Date.now()+Math.random()),
        key: o?.key ?? 'sort',
        name: o?.name ?? 'Sort√©r',
        color: o?.color ?? getCSS('--c-sort'),
        text: o?.text ?? '',
        photos: Array.isArray(o?.photos) ? o.photos : [],
        where: o?.where ?? '',
        resp:  o?.resp  ?? '',
        ts: o?.ts ?? new Date().toISOString()
      }));
      const sum = Object.values(scores).reduce((a,b)=>a+(+b||0),0);
      const migratePayload = {
        meta: { dept: meta.dept || '', name: meta.name || '', date: meta.date || today() },
        scores,
        observations,
        scorePct: Math.round(sum / (5*5) * 100)
      };
      localStorage.setItem(SKEY, JSON.stringify(migratePayload));
      localStorage.removeItem(oldKey);
      break;
    } catch(e) { console.warn('Migration fejl for', oldKey, e); }
  }
}

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded',()=>{
  try{
    $('#date').value=today();
    $('#printBtn').addEventListener('click',()=>window.print(),{passive:true});
    buildBlocks(); buildScoreList(); bindEvents();
    migrateDraftsIfNeeded();
    restore();
    updateTotals();
    $('#statusTxt').textContent='Klar';

    $$('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        const tab=btn.dataset.tab;
        $('#auditPanel').style.display = tab==='audit' ? 'block' : 'none';
        $('#mapPanel').style.display   = tab==='map'   ? 'block' : 'none';
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });

    window.addEventListener('resize', renderRadar, {passive:true});
    renderRadar();
  }catch(err){ console.error('Init fejl:',err); $('#statusTxt').textContent='Init-fejl'; }
});

/* ===== UI byggere ===== */
function buildBlocks(){
  const root=$('#blocks');
  S5.forEach(s=>{
    const d=document.createElement('div'); d.className='sblock'; d.style.setProperty('--col',s.color);
    d.innerHTML=`
      <div class="srow">
        <div class="title" style="color:${s.color}">${s.name}</div>
        <div class="step">
          <button type="button" data-dec="${s.key}">‚àí</button>
          <div class="bubble" id="b-${s.key}">0</div>
          <button type="button" data-inc="${s.key}">+</button>
        </div>
        <div class="sliderWrap">
          <span class="mini">0</span>
          <input id="r-${s.key}" type="range" min="0" max="5" step="1" value="0" aria-label="${s.name} score">
          <span class="mini">5</span>
        </div>
        <button class="btn secondary" type="button" data-add="${s.key}">+ Tilf√∏j observation</button>
      </div>
      <div class="miniBar"><span id="mb-${s.key}" style="background:${s.color}"></span></div>

      <div id="f-${s.key}" style="display:none;margin-top:10px;border-top:1px dashed var(--line);padding-top:10px">
        <label for="t-${s.key}">Observation</label>
        <textarea id="t-${s.key}" placeholder="Skriv observation‚Ä¶"></textarea>

        <div class="formRow" style="margin-top:8px">
          <div class="field">
            <label for="loc-${s.key}">Hvor</label>
            <!-- S√∏gbart med datalist -->
            <input id="loc-${s.key}" list="locOptions" placeholder="S√∏g og v√¶lg lokation‚Ä¶" />
          </div>
          <div class="field">
            <label for="resp-${s.key}">Ansvarlig</label>
            <select id="resp-${s.key}">
              <option value="" disabled selected>V√¶lg‚Ä¶</option>
              <option>Jan Ovesen</option>
              <option>Martin Maximilian</option>
              <option>Jan Vestergaard Troelsen</option>
              <option>Bjarke Asferg</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <label class="btn ghost" for="img-${s.key}">Tilf√∏j billede(r)</label>
          <input id="img-${s.key}" type="file" accept="image/*" multiple style="display:none">
          <div id="prev-${s.key}" style="display:flex;gap:6px;flex-wrap:wrap"></div>
          <span class="mini" style="margin-left:auto">Valgfrit ¬∑ maks 5 billeder</span>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="btn ok" type="button" data-save="${s.key}">Gem observation</button>
          <button class="btn" type="button" data-cancel="${s.key}">Annull√©r</button>
        </div>
      </div>`;
    root.appendChild(d);
  });
}
function buildScoreList(){
  const t=$('#scoreList'); t.innerHTML='';
  S5.forEach(s=>{
    const row=document.createElement('div'); row.className='sitem';
    row.innerHTML=`
      <div class="shead"><span style="color:${s.color};font-weight:800">${s.name}</span><span id="sv-${s.key}">0/5</span></div>
      <div class="sbar"><span id="sb-${s.key}" style="background:${s.color};width:0%"></span></div>
      <div class="sex">${s.tip}</div>`;
    t.appendChild(row);
  });
}

/* ===== Radar chart ===== */
function renderRadar(){
  const canvas = $('#radar');
  if(!canvas) return;
  const dpr = window.devicePixelRatio || 1;
  const bbox = canvas.getBoundingClientRect();
  canvas.width = Math.floor((bbox.width||360) * dpr);
  canvas.height = Math.floor((bbox.height||280) * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr);
  const W = bbox.width || 360, H = bbox.height || 280;
  ctx.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2 + 10;
  const radius = Math.min(W, H) * 0.38;
  const axes = S5.length, maxVal = 5;

  // grid
  ctx.strokeStyle = '#e5eaf0';
  ctx.lineWidth = 1;
  for(let r=1;r<=5;r++){
    ctx.beginPath();
    for(let i=0;i<axes;i++){
      const a=(-Math.PI/2)+(i*2*Math.PI/axes);
      const x=cx+Math.cos(a)*radius*(r/5);
      const y=cy+Math.sin(a)*radius*(r/5);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.closePath(); ctx.stroke();
  }
  // axes + labels
  ctx.font='12px Segoe UI,system-ui';
  ctx.fillStyle='#334155';
  for(let i=0;i<axes;i++){
    const a=(-Math.PI/2)+(i*2*Math.PI/axes);
    const x=cx+Math.cos(a)*radius, y=cy+Math.sin(a)*radius;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
    const lx=cx+Math.cos(a)*(radius+14), ly=cy+Math.sin(a)*(radius+14);
    ctx.textAlign=Math.abs(Math.cos(a))<0.3?'center':(Math.cos(a)>0?'left':'right');
    ctx.textBaseline=Math.abs(Math.sin(a))<0.3?'middle':(Math.sin(a)>0?'top':'bottom');
    ctx.fillText(S5[i].name,lx,ly);
  }
  // data
  const vals=S5.map(s=>+SCORES[s.key]||0);
  ctx.beginPath();
  vals.forEach((v,i)=>{
    const a=(-Math.PI/2)+(i*2*Math.PI/axes);
    const r=radius*(v/maxVal);
    const x=cx+Math.cos(a)*r, y=cy+Math.sin(a)*r;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.fillStyle='rgba(59,130,246,0.2)'; ctx.fill();
  ctx.strokeStyle=getCSS('--accent'); ctx.lineWidth=2; ctx.stroke();

  ctx.fillStyle='#fff'; ctx.strokeStyle=getCSS('--accent');
  vals.forEach((v,i)=>{
    const a=(-Math.PI/2)+(i*2*Math.PI/axes);
    const r=radius*(v/maxVal);
    const x=cx+Math.cos(a)*r, y=cy+Math.sin(a)*r;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); ctx.stroke();
  });
}

/* ===== Events ===== */
function bindEvents(){
  S5.forEach(s=>{
    $('#r-'+s.key)?.addEventListener('input',e=>setScore(s.key,+e.target.value),{passive:true});
    document.querySelector(`[data-inc="${s.key}"]`)?.addEventListener('click',()=>setScore(s.key,clamp(SCORES[s.key]+1,0,5)));
    document.querySelector(`[data-dec="${s.key}"]`)?.addEventListener('click',()=>setScore(s.key,clamp(SCORES[s.key]-1,0,5)));
    document.querySelector(`[data-add="${s.key}"]`)?.addEventListener('click',()=>toggleForm(s.key,true));
    document.querySelector(`[data-cancel="${s.key}"]`)?.addEventListener('click',()=>toggleForm(s.key,false));
    $('#img-'+s.key)?.addEventListener('change',()=>previewThumbs(s.key));
    document.querySelector(`[data-save="${s.key}"]`)?.addEventListener('click',()=>saveObservation(s.key));
  });
  $('#saveBtn')?.addEventListener('click',()=>{saveDraft(); toast('Kladde gemt');});
  $('#clearBtn')?.addEventListener('click',()=>{ if(confirm('Ryd formular og observationer?')){ localStorage.removeItem(SKEY); location.reload(); } });
  $('#sendBtn')?.addEventListener('click',async ()=>{
    const ok = await showConfirmModal();
    if(ok) sendPayload();
  });
}

/* ===== Logik ===== */
function setScore(key,val,{save=true}={}){
  SCORES[key]=val;
  $('#b-'+key).textContent=String(val);
  $('#r-'+key).value=String(val);
  $('#mb-'+key).style.width=(val*20)+'%';
  $('#sv-'+key).textContent=`${val}/5`;
  $('#sb-'+key).style.width=(val*20)+'%';
  updateTotals();
  if(save && !IS_RESTORING) saveDraftSilent();
  renderRadar();
}
function previewThumbs(key){
  const c=$('#prev-'+key); if(!c) return; c.innerHTML='';
  const files=Array.from($('#img-'+key)?.files||[]);
  const maxN=5, use=files.slice(0,maxN);
  if(files.length>maxN){
    const note=document.createElement('div'); note.className='mini';
    note.textContent=`Viser de f√∏rste ${maxN} billeder (max ${maxN}).`;
    c.appendChild(note);
  }
  for(const f of use){
    const u=URL.createObjectURL(f); const im=new Image();
    im.src=u; im.style.height='48px'; im.style.border='1px solid var(--line)'; im.style.borderRadius='8px';
    im.onload=()=>URL.revokeObjectURL(u); c.appendChild(im);
  }
}
async function saveObservation(key){
  const ta=$('#t-'+key);
  const text=(ta?.value||'').trim(); if(!text) return alert('Skriv en observation.');
  const whereSel = ($('#loc-'+key)?.value||'').trim();
  const respSel  = $('#resp-'+key)?.value || '';
  if(!respSel)  return alert('V√¶lg ansvarlig.');

  const files=$('#img-'+key)?.files||[];
  const photos=await getUpToNCompressed(files,5,350);
  const s=S5.find(x=>x.key===key);
  OBS.push({
    id:Date.now()+Math.random(),
    key, name:s.name, color:s.color,
    text, where: whereSel, resp: respSel,
    photos, ts:new Date().toISOString()
  });
  if(ta) ta.value=''; const input=$('#img-'+key); if(input) input.value=''; const prev=$('#prev-'+key); if(prev) prev.innerHTML='';
  $('#loc-'+key).value=''; $('#resp-'+key).value='';
  toggleForm(key,false); renderObs(); saveDraftSilent();
}
function renderObs(){
  const body=$('#obsBody'); if(!body) return; body.innerHTML='';
  if(!OBS.length){ body.innerHTML='<tr><td colspan="4" style="text-align:center;color:#65758b;padding:16px">Ingen observationer endnu.</td></tr>'; return; }
  OBS.forEach((o,i)=>{
    const tr=document.createElement('tr');
    const chip=`<span class="chip5" style="border-color:${o.color}"><span style="width:10px;height:10px;border-radius:999px;background:${o.color}"></span>${o.name}</span>`;
    const meta = `
      <div class="mini" style="margin-top:4px">
        ${o.where ? `üìç ${escapeHTML(o.where)} ¬∑ ` : ''}üë§ ${escapeHTML(o.resp||'')}
      </div>`;
    const thumbs=o.photos.map(p=>`<img src="${p}" style="height:44px;border:1px solid var(--line);border-radius:8px" alt=""/>`).join('');
    tr.innerHTML=`
      <td>${chip}<div class="mini">${new Date(o.ts).toLocaleString()}</div></td>
      <td>${escapeHTML(short(o.text))}${meta}</td>
      <td><div style="display:flex;gap:6px;flex-wrap:wrap">${thumbs}</div></td>
      <td><button class="btn secondary" type="button" data-del="${o.id}">Slet</button></td>`;
    body.appendChild(tr);
  });
  body.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{const id=+b.getAttribute('data-del'); OBS=OBS.filter(x=>x.id!==id); renderObs(); saveDraftSilent();}));
}

/* ===== State / persistence ===== */
function updateTotals(){
  const sum=Object.values(SCORES).reduce((a,b)=>a+b,0), max=5*S5.length, pct=Math.round((sum/max)*100);
  $('#totalBox').textContent=`Total: ${sum}/${max} (${pct}%)`;
  $('#statusTxt').textContent=`Total: ${sum}/${max} (${pct}%)`;
  $('#statusDot').style.background = pct>=70?'var(--ok)': pct>=40?'var(--mid)':'var(--bad)';
}
function collect(){
  return {
    meta:{dept:$('#dept').value||'', name:$('#name').value||'', date:$('#date').value||today()},
    scores:{...SCORES}, observations:OBS,
    scorePct:Math.round(Object.values(SCORES).reduce((a,b)=>a+b,0)/(5*S5.length)*100)
  };
}
function saveDraft(){ localStorage.setItem(SKEY, JSON.stringify(collect())); }
function saveDraftSilent(){ try{ localStorage.setItem(SKEY, JSON.stringify(collect())); }catch(e){} }
function restore(){
  try{
    const raw=localStorage.getItem(SKEY); if(!raw) return;
    const d=JSON.parse(raw);

    IS_RESTORING = true;

    $('#dept').value=d.meta?.dept||''; $('#name').value=d.meta?.name||''; $('#date').value=d.meta?.date||today();
    OBS = Array.isArray(d.observations) ? d.observations : [];
    renderObs();
    Object.entries(d.scores||{}).forEach(([k,v])=> setScore(k, v, {save:false}));

    IS_RESTORING = false;
    renderRadar();
  }catch(e){ console.warn('Kunne ikke gendanne kladde:', e); IS_RESTORING=false; renderRadar(); }
}
function toggleForm(key,show){ const f=$('#f-'+key); if(f){ f.style.display=show?'block':'none'; if(show) $('#t-'+key)?.focus(); } }

/* ===== Modal utils ===== */
function showConfirmModal(){
  return new Promise(resolve=>{
    const overlay = $('#confirmModal');
    const okBtn = $('#confirmOk');
    const cancelBtn = $('#confirmCancel');

    function close(result){
      overlay.classList.remove('show');
      document.removeEventListener('keydown', onKey);
      okBtn.onclick = cancelBtn.onclick = null;
      resolve(result);
    }
    function onKey(e){
      if(e.key==='Escape') close(false);
      if(e.key==='Enter') close(true);
    }

    okBtn.onclick = ()=>close(true);
    cancelBtn.onclick = ()=>close(false);
    overlay.classList.add('show');
    document.addEventListener('keydown', onKey);
    setTimeout(()=> okBtn.focus(), 0);
  });
}

/* ===== Send ===== */
async function sendPayload(){
  try{
    $('#statusTxt').textContent='Sender‚Ä¶';
    const dept=($('#dept').value||'').trim();
    const name=($('#name').value||'').trim();
    const date=($('#date').value||'').trim();
    if(!dept) return alert('V√¶lg Afdeling');
    if(!name) return alert('Skriv Navn');
    if(!date) return alert('V√¶lg Dato');

    const data=collect();

    const auditBody={
      Title:`5S Audit ‚Äì ${dept} ‚Äì ${date}`,
      Navn:name, Dato:date, Afdeling:dept,
      Sorter:Number(data.scores.sort||0),
      Systematiser:Number(data.scores.set||0),
      Shine:Number(data.scores.shine||0),
      Standardiser:Number(data.scores.std||0),
      Sustain:Number(data.scores.sus||0),
      ScorePct:Number(data.scorePct||0)
    };

    const resAudit=await fetch(ENDPOINT_AUDIT,{
      method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify(auditBody), mode:'cors'
    }).catch(err=>{throw new Error('Netv√¶rksfejl (Audit): '+err.message);});

    const auditTxt=await resAudit.text();
    let auditResp={}; try{ auditResp=auditTxt?JSON.parse(auditTxt):{}; }catch{}
    if(!resAudit.ok){ throw new Error(`Audit-fejl ${resAudit.status}: ${auditTxt||''}`); }

    const observations=OBS.map((o,i)=>({
      s:o.name,
      beskrivelse:(o.text||'').trim(),
      hvor:o.where||'',
      ansvarlig:o.resp||'',
      handling:'',
      forfaldsdato:'',
      status:'Afventer status',
      images:(o.photos||[]).map((b64,k)=>({fileName:`obs_${i+1}_${k+1}.jpg`, dataUrl:b64}))
    }));

    const obsBody={
      audit:{
        navn:name, dato:date, afdeling:dept,
        scorePct:Number(data.scorePct||0),
        scores:{
          sort:Number(data.scores.sort||0),
          set:Number(data.scores.set||0),
          shine:Number(data.scores.shine||0),
          std:Number(data.scores.std||0),
          sus:Number(data.scores.sus||0)
        }
      },
      observations
    };

    const resObs=await fetch(ENDPOINT_OBS,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify(obsBody), mode:'cors'
    }).catch(err=>{throw new Error('Netv√¶rksfejl (Obs): '+err.message);});

    const obsTxt=await resObs.text();
    if(!resObs.ok){ throw new Error(`Obs-fejl ${resObs.status}: ${obsTxt||''}`); }

    $('#statusTxt').textContent=`Sendt ‚úì ‚Äî Audit + ${observations.length} obs`;
    alert(`Audit oprettet og ${observations.length} observation(er) oprettet i SharePoint`);

    localStorage.removeItem(SKEY);
    location.reload();

  }catch(e){
    console.error(e);
    $('#statusTxt').textContent='Fejl ved indsending';
    alert(e.message||e);
  }
}

/* ===== Advarsel ved luk/opdater ===== */
window.addEventListener('beforeunload', function (e) {
  if (localStorage.getItem(SKEY)) {
    e.preventDefault();
    e.returnValue = 'Du har ikke indsendt audit og observationer. Forlad siden?';
  }
});
</script>
</body>
</html>
