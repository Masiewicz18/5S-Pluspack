<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Omstilling ‚Äì Tidsstempling</title>
<style>
  :root{
    --bg:#0b1222; --bg2:#0f172a; --fg:#eef2ff; --muted:#a5b4fc;
    --card:#0f172a; --card2:#0b1020; --accent:#60a5fa; --accent-2:#22d3ee;
    --danger:#ef4444; --warn:#f59e0b; --success:#22c55e; --border:#1f2937;
    --chip:#0b132a; --input:#0b1222; --textmuted:#cbd5e1;
    --step1:#0ea5e9; --step2:#22c55e; --step3:#f59e0b; --step4:#a78bfa; --step5:#38bdf8; --step6:#f97316;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 35% 65%,var(--bg));color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
  .app{background:linear-gradient(180deg,rgba(17,24,39,.85),rgba(11,18,34,.9));border:1px solid var(--border);border-radius:22px;box-shadow:0 12px 40px rgba(0,0,0,.45);overflow:hidden}

  /* Header */
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(2,6,23,.9),rgba(2,6,23,.6));backdrop-filter:blur(6px);display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border)}
  .head-left{display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand-name{
    font-weight:900;letter-spacing:.6px;font-size:18px;line-height:1.1;
    background:linear-gradient(90deg,#fff 0%, #a5b4fc 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }
  .brand small{display:block;font-weight:600;letter-spacing:.2px;color:#cbd5e1;opacity:.8}

  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--fg);font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#64748b}

  .subnav{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--card2);border-bottom:1px solid var(--border)}
  .subbtn{border:1px solid var(--border);background:#0b1222;color:#cbd5e1;border-radius:999px;padding:8px 12px;cursor:pointer}
  .subbtn.active{outline:2px solid var(--accent);color:#fff}

  .tabs{display:flex;gap:10px;align-items:center;padding:12px;background:var(--card2);border-bottom:1px solid var(--border);overflow:auto;z-index:25;position:relative}
  .tab{display:flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:220px;max-width:300px;padding:10px 14px;border:1px solid #20314c;border-radius:16px;background:#0f1a33;color:#eaf2ff;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .tab .row{display:flex;gap:8px;align-items:center}
  .tab .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tab .meta{font-size:12px;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tab .state{font-size:11px;opacity:.95}
  .tab .badgeAct{display:none;font-size:11px;padding:2px 6px;border-radius:999px;background:rgba(255,255,255,.15)}
  .tab.sent{opacity:.9}
  .tab[aria-selected="true"]{
    background:linear-gradient(180deg,var(--accent),var(--accent-2));
    color:#081019;border-color:transparent;box-shadow:0 10px 24px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.25)
  }
  .tab[aria-selected="true"] .badgeAct{display:inline-block}
  .tab .close{margin-left:auto;padding:0 .35rem;border:1px solid #3a4a68;border-radius:10px;background:#081325;color:#cbd5e1;cursor:pointer}
  .tab[aria-selected="true"] .close{background:rgba(0,0,0,.1);color:#081019;border-color:rgba(0,0,0,.15)}
  .tab-add,.tab-more{background:#0a1226;border:1px dashed var(--border);color:#cbd5e1;border-radius:14px;padding:10px 12px;cursor:pointer;white-space:nowrap}
  .tab,.tab-add,.tab-more{user-select:none}

  .toolbar{display:flex;gap:10px;align-items:center;padding:10px 18px;background:var(--card2);border-bottom:1px solid var(--border)}
  .btn{appearance:none;border:none;border-radius:14px;padding:12px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px;display:inline-flex;align-items:center;gap:6px}
  .btn.secondary{background:#111827;color:#cbd5e1;border:1px solid var(--border)}
  .btn.ghost{background:transparent;color:#cbd5e1;border:1px dashed var(--border)}
  .btn.warn{background:var(--warn);color:#111}
  .btn.success{background:var(--success);color:#07140f}
  .btn.accent{background:var(--accent);color:#081019}
  .btn.print{background:#38bdf8;color:#081019}

  .progress{flex:1;height:10px;border-radius:999px;background:#0a1226;position:relative;overflow:hidden;border:1px solid var(--border)}
  .progress>span{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .25s ease}
  .progressLabel{min-width:120px;text-align:right;font-size:12px;color:#c7d2fe}

  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;padding:18px}
  .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
  @media(max-width:1024px){.col-4,.col-6,.col-8{grid-column:span 12}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px}
  .card h3{margin:0 0 10px;font-size:16px;color:#e2e8f0;display:flex;align-items:center;gap:10px}
  .badge{display:inline-flex;align-items:center;gap:6px;font:600 12px/1 ui-sans-serif;padding:6px 10px;border-radius:999px;background:#0b1222;border:1px solid var(--border)}
  .badge .dot{width:8px;height:8px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0a1226;font-size:12px}

  label{display:block;font-size:13px;color:var(--textmuted);margin:8px 0 6px}
  input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:var(--input);color:var(--fg);outline:none}
  input::placeholder, textarea::placeholder{color:var(--textmuted)}

  .tasks{display:grid;gap:8px}
  .task{display:flex;align-items:center;gap:12px;padding:10px 12px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#0b1222,#0c1426)}
  .task input[type="checkbox"]{width:22px;height:22px}
  .task .txt{flex:1}
  .task .ts{font:12px ui-monospace,monospace;color:#93c5fd;margin-left:auto}
  .task.done{opacity:.55}

  .readouts{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
  @media(max-width:1200px){.readouts{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:640px){.readouts{grid-template-columns:1fr}}
  .read{font:800 20px/1 ui-monospace,monospace}
  .note{font-size:12px;color:#9ca3af}

  .footer{position:sticky;bottom:0;z-index:15;background:linear-gradient(180deg,rgba(2,6,23,.6),rgba(2,6,23,.9));backdrop-filter:blur(6px);display:flex;gap:10px;justify-content:flex-end;margin-top:8px;padding:12px 18px;border-top:1px solid var(--border)}

  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{font-size:12px;color:#cbd5e1}
  .miniBar{height:10px;background:#0a1226;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .miniBar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0}

  body[data-theme='light']{
    --bg:#f3f4f6; --bg2:#ffffff; --fg:#0b1222; --textmuted:#0b1222;
    --card:#ffffff; --card2:#f8fafc; --accent:#2563eb; --accent-2:#06b6d4; --danger:#b91c1c; --warn:#d97706; --success:#16a34a; --border:#e5e7eb; --chip:#eef2ff; --input:#ffffff;
  }
  body[data-theme='light'] .app{background:#ffffff;border-color:#e5e7eb;box-shadow:0 4px 24px rgba(0,0,0,.08)}
  body[data-theme='light'] header, body[data-theme='light'] .footer{background:#ffffff;border-color:#e5e7eb}
  body[data-theme='light'] .toolbar,.subnav,.tabs{background:#f8fafc}
  body[data-theme='light'] .task{background:#ffffff;border-color:#e5e7eb}
  body[data-theme='light'] .task .ts{color:#111827;font-weight:600;background:#eef2ff;padding:2px 6px;border-radius:6px}
  body[data-theme='light'] .btn.secondary{background:#ffffff;color:#0b1222;border:1px solid #cbd5e1}
  body[data-theme='light'] .chip{background:#f1f5f9;color:#0b1222;border-color:#cbd5e1}
  body[data-theme='light'] .badge{background:#eef2ff;color:#0b1222;border-color:#cbd5e1}
  body[data-theme='light'] .pill{background:#eef2ff;color:#0b1222;border-color:#cbd5e1}
  body[data-theme='light'] .progress{background:#e5e7eb;border-color:#e5e7eb}
  body[data-theme='light'] .brand-name{background:linear-gradient(90deg,#0b1222 0%, #475569 100%);-webkit-background-clip:text;background-clip:text}

  body:not([data-theme='light']) .tabs,
  body:not([data-theme='light']) .subnav,
  body:not([data-theme='light']) .toolbar{ background-color:var(--card2) !important; }

  @media print{
    body{background:#fff!important;color:#000}
    .wrap{max-width:100%;margin:0;padding:0}
    header,.toolbar,.footer,#feedback,.tabs,.subnav,#templateModal{display:none!important}
    .app{box-shadow:none;border:none}
    .card{background:#fff;border:1px solid #000}
    .task{background:#fff;border-color:#000}
    .pill{border-color:#000}
  }

  .btn[data-icon="start"]::before{content:"‚è±Ô∏è";margin-right:8px}
  .btn[data-icon="run"]::before{content:"‚úÖ";margin-right:8px}
  .btn[data-icon="submit"]::before{content:"üì§";margin-right:8px}
  .btn[data-icon="save"]::before{content:"üíæ";margin-right:8px}
  .btn[data-icon="clear"]::before{content:"üßπ";margin-right:8px}

  #templateModal[hidden]{display:none}
  #templateModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}
  .modalCard{width:min(520px,95vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
  .tmplRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .tmplBtn{flex:1 1 220px;border:1px solid var(--border);background:#0a1226;color:#eaf2ff;padding:12px;border-radius:12px;cursor:pointer;text-align:left}
  .tmplBtn:hover{outline:2px solid var(--accent)}
</style>

<script>
  /* S√¶t jeres Power Automate HTTP-endpoint her */
  window.OMSTILLING_ENDPOINT = "https://prod-71.westeurope.logic.azure.com:443/workflows/3b731a0f1bf64720ac52b562d93321b7/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=x9RHoO0On3r50nepjlUfBH-CGaVXDN6tlD1Ur_m-Q0E";
</script>
</head>
<body>
<div class="wrap">
  <div class="app" role="application" aria-label="Omstilling ‚Äì tidsstempling">
    <header>
      <div class="head-left">
        <div class="brand">
          <div class="brand-name">Plus&nbsp;Pack<small>Omstilling ‚Äì Tidsstempling</small></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button type="button" id="themeToggle" class="btn secondary">‚òÄÔ∏è Lys</button>
        <button type="button" id="printBtn" class="btn print">üñ®Ô∏è Print</button>
        <span class="chip"><span class="dot" id="statusDot"></span><span id="statusText">Klar</span></span>
      </div>
    </header>

    <div class="subnav">
      <button id="navMain" class="subbtn active">Tjekliste</button>
      <button id="navHist" class="subbtn">Historik</button>
    </div>

    <!-- Faner -->
    <div class="tabs" id="tabs">
      <div id="addTab" class="tab-add" role="button" tabindex="0">Ôºã Ny tjekliste</div>
    </div>

    <section id="view-main">
      <div class="toolbar">
        <button type="button" id="toggleDone" class="btn secondary">Vis kun √•bne</button>
        <div class="progress"><span id="progBar"></span></div>
        <div class="progressLabel"><span id="progText">0 / 0 f√¶rdige</span></div>
      </div>

      <form id="form" class="grid" autocomplete="on">
        <div class="card col-8">
          <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px">
            <div style="grid-column:span 6">
              <label for="operator">Omstiller <span style="color:#fca5a5">*</span></label>
              <input id="operator" placeholder="Dit navn" required />
            </div>
            <div style="grid-column:span 6">
              <label for="line">Linje <span style="color:#fca5a5">*</span></label>
              <select id="line" required>
                <option value="" disabled selected>V√¶lg‚Ä¶</option>
                <option>77</option><option>76</option><option>75</option><option>74</option>
                <option>73</option><option>72</option><option>71</option><option>70</option>
                <option>65</option><option>64</option><option>63</option><option>62</option>
                <option>61</option><option>60</option><option>55</option><option>54</option><option>50</option>
              </select>
            </div>

            <div style="grid-column:span 6">
              <label for="order">Ordrenr.</label>
              <input id="order" placeholder="Fx 45001234" />
            </div>
            <div style="grid-column:span 6">
              <label for="varenr">Vare nr.</label>
              <input id="varenr" placeholder="Fx 123456" />
            </div>

            <div style="grid-column:span 6">
              <label for="toolno">V√¶rkt√∏jsnr.</label>
              <input id="toolno" placeholder="Fx VKT-1234" />
            </div>

            <div style="grid-column:span 12">
              <label for="tmplSelect">Skabelon</label>
              <select id="tmplSelect"></select>
            </div>
          </div>
        </div>

        <div class="card col-4">
          <h3><span class="badge"><span class="dot" style="background:var(--step2)"></span>Godkendelse</span></h3>
          <label for="approver">Godkender</label>
          <input id="approver" placeholder="Fx Teamleder" />
          <label class="chip" style="margin-top:8px;display:inline-flex;gap:8px;align-items:center">
            <input type="checkbox" id="approveCheck"> Jeg bekr√¶fter at data er korrekte
          </label>
        </div>

        <!-- Trin-kort 1..6 (samme som f√∏r) -->
        <div class="card col-12" data-stepcard="1">
          <h3><span class="badge"><span class="dot" style="background:var(--step1)"></span><span class="stepTitle" data-st="1">Trin 1</span></h3>
          <div class="tasks" id="tasks-1"></div>
          <div class="pill" style="margin-top:10px">Starttid: <span id="t1Start">‚Äì</span></div>
          <div style="margin-top:10px"><button type="button" class="btn warn" data-stamp-btn="1" data-icon="start">Stempl START</button></div>
        </div>

        <div class="card col-12" data-stepcard="2">
          <h3><span class="badge"><span class="dot" style="background:var(--step2)"></span><span class="stepTitle" data-st="2">Trin 2</span></h3>
          <div class="tasks" id="tasks-2"></div>
          <div class="pill" style="margin-top:10px">Starttid: <span id="t2Start">‚Äì</span></div>
          <div style="margin-top:10px"><button type="button" class="btn secondary" data-stamp-btn="2" data-icon="start">Stempl START</button></div>
        </div>

        <div class="card col-12" data-stepcard="3">
          <h3><span class="badge"><span class="dot" style="background:var(--step3)"></span><span class="stepTitle" data-st="3">Trin 3</span></h3>
          <div class="tasks" id="tasks-3"></div>
          <div class="pill" style="margin-top:10px">Starttid: <span id="t3Start">‚Äì</span></div>
          <div style="margin-top:10px"><button type="button" class="btn secondary" data-stamp-btn="3" data-icon="start">Stempl START</button></div>
        </div>

        <div class="card col-12" data-stepcard="4">
          <h3><span class="badge"><span class="dot" style="background:var(--step4)"></span><span class="stepTitle" data-st="4">Trin 4</span></h3>
          <div class="tasks" id="tasks-4"></div>
          <div class="pill" style="margin-top:10px">Starttid: <span id="t4Start">‚Äì</span></div>
          <div style="margin-top:10px"><button type="button" class="btn secondary" data-stamp-btn="4" data-icon="start">Stempl START</button></div>
        </div>

        <div class="card col-12" data-stepcard="5">
          <h3><span class="badge"><span class="dot" style="background:var(--step5)"></span><span class="stepTitle" data-st="5">Trin 5</span></h3>
          <div class="tasks" id="tasks-5"></div>
          <div class="pill" style="margin-top:10px">Starttid: <span id="t5Start">‚Äì</span></div>
          <div style="margin-top:10px"><button type="button" class="btn secondary" data-stamp-btn="5" data-icon="start">Stempl START</button></div>
        </div>

        <div class="card col-12" data-stepcard="6">
          <h3><span class="badge"><span class="dot" style="background:var(--step6)"></span><span class="stepTitle" data-st="6">Trin 6</span></h3>
          <div class="tasks" id="tasks-6"></div>
          <div class="pill" style="margin-top:10px">Start: <span id="t6Start">‚Äì</span> ‚Ä¢ I DRIFT: <span id="tInRun">‚Äì</span></div>
          <div style="margin-top:10px"><button type="button" class="btn secondary" data-stamp-btn="6" data-icon="start">Stempl START</button> <button type="button" class="btn success" id="btnInRun" data-icon="run">Stempl I DRIFT</button></div>
        </div>

        <div class="card col-12" id="commentSection">
          <h3>Generel kommentar</h3>
          <textarea id="generalComment" placeholder="Evt. ekstra noter‚Ä¶"></textarea>
        </div>

        <div class="card col-12">
          <h3><span class="badge"><span class="dot" style="background:var(--step5)"></span>Tidsoverblik</span></h3>
          <div class="readouts">
            <div><div class="note" id="lbl12">Trin 1 ‚Üí 2</div><div class="read" id="r12">00:00:00</div></div>
            <div><div class="note" id="lbl23">Trin 2 ‚Üí 3</div><div class="read" id="r23">00:00:00</div></div>
            <div><div class="note" id="lbl34">Trin 3 ‚Üí 4</div><div class="read" id="r34">00:00:00</div></div>
            <div><div class="note" id="lbl45">Trin 4 ‚Üí 5</div><div class="read" id="r45">00:00:00</div></div>
            <div><div class="note" id="lblTot">Start (Trin 1) ‚Üí I DRIFT</div><div class="read" id="rTotal">00:00:00</div></div>
          </div>
        </div>

        <div class="footer col-12">
          <button type="button" id="saveDraft" class="btn ghost" data-icon="save">Gem kladde</button>
          <button type="button" id="clearBtn" class="btn secondary" data-icon="clear">Ryd</button>
          <button type="submit" class="btn accent" data-icon="submit">Indsend</button>
        </div>
        <div id="feedback" class="col-12" aria-live="polite"></div>
      </form>
    </section>

    <section id="view-hist" style="display:none">
      <div class="card" style="margin:16px">
        <h3>Igangv√¶rende tjeklister</h3>
        <div id="histWrap" style="overflow:auto;max-height:70vh;border:1px solid var(--border);border-radius:12px">
          <table>
            <thead><tr>
              <th>Status</th><th>Trin n√•et</th><th>Fremskridt</th>
              <th>Operat√∏r</th><th>Linje</th><th>Ordre</th><th>Handling</th>
            </tr></thead>
            <tbody id="histBody"></tbody>
          </table>
        </div>
        <p id="histEmpty" class="note" style="display:none;margin-top:10px">Ingen igangv√¶rende tjeklister.</p>
      </div>
    </section>
  </div>
</div>

<!-- Skabelonv√¶lger -->
<div id="templateModal" hidden>
  <div class="modalCard">
    <h3>V√¶lg skabelon</h3>
    <div class="tmplRow" id="tmplBtns"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="tmplCancel">Luk</button>
    </div>
  </div>
</div>

<script>
/* ---------- Skabeloner ---------- */
const TEMPLATES={
  "form_stanse_adskilt":{name:"Form- og stansesektioner adskilt",hideSteps:[],steps:{
    1:{title:"Trin 1 ‚Äì Forberedelse",tasks:["Log ind p√• omstilling","Tjek v√¶rkt√∏jsloggen for tidligere h√¶ndelser relateret til v√¶rkt√∏jet","Verific√©r v√¶rkt√∏jsnummer stemmer med produktionsordre","S√¶t maskine i v√¶rkt√∏jsskift","K√∏r stansestation til h√∏jre","T√∏m v√¶rkt√∏j for vand og t√∏m k√∏levandsdunk","Afmonter k√∏leslanger fra formv√¶rkt√∏j"]},
    2:{title:"Trin 2 ‚Äì Form Station",tasks:["Afmontering: L√∏sn formv√¶rkt√∏j, fjern √òVRE og NEDRE formstation","Ops√¶tning: Monter ny formstation (√òVRE og NEDRE), luk og centr√©r v√¶rkt√∏j korrekt","K√∏ling: Tilslut k√∏leslanger, fjern overskydende slanger og h√¶ng dem op"]},
    3:{title:"Trin 3 ‚Äì Stanse Station",tasks:["Afmontering: L√∏sn stansv√¶rkt√∏j og afmonter √òVRE og NEDRE del","Ops√¶tning: Monter ny stansestation. Sp√¶nd overstans og understans","Sikr afstand mellem knive og bundform, just√©r ved indk√∏ring"]},
    4:{title:"Trin 4 ‚Äì Stabel Station",tasks:["Afmontering: L√∏sn stabelstation","Afmonter stabelstation","Ops√¶t ny stabelstation","Sp√¶nd","Just√©r bufferbord"]},
    5:{title:"Trin 5 ‚Äì Indl√¶s & Justering",tasks:["Inds√¶t folie og t√¶nd for opvarmningsfolie","Kontroll√©r at alle stationer er p√• plads","Indstil: varme i sl√¶de, k√∏leplade, afbl√¶sning og skab","Indl√¶s program og just√©r sp√¶nding","T√¶nd for vand","Sl√• start-automatik fra","T√¶nd PP-folie og start"]},
    6:{title:"Trin 6 ‚Äì Indk√∏ring",tasks:["Form og stans trinvist ‚Äì lav pr√∏vestans: Indstil startposition: 0,3‚Äì0,5 mm over sk√¶reh√∏jde (min. 0,5 mm ved nye knive)","K√∏r v√¶rkt√∏j manuelt eller med jog-funktion","Lav pr√∏vestans i folie efter hvert trin og inspic√©r emnet grundigt","Just√©r indtil resultatet er rent, uden grater eller fl√¶k","Ops√¶t og kalibr√©r stabelsektion (udskubber og stabelsk√•l/robot)","F√• formandens godkendelse og frigiv til produktion"]}
  }},
  "bfs":{name:"BFS V√¶rkt√∏j",hideSteps:[3],steps:{
    1:{title:"Trin 1 ‚Äì Forberedelse",tasks:["Log ind p√• omstilling","Tjek v√¶rkt√∏jsloggen for tidligere h√¶ndelser relateret til v√¶rkt√∏jet","Verific√©r v√¶rkt√∏jsnummer stemmer med produktionsordre","S√¶t maskine i v√¶rkt√∏jsskift","K√∏r stansestation til h√∏jre","T√∏m v√¶rkt√∏j for vand og t√∏m k√∏levandsdunk","Afmonter k√∏leslanger fra formv√¶rkt√∏j"]},
    2:{title:"Trin 2 ‚Äì Form Station",tasks:["Afmontering: L√∏sn formv√¶rkt√∏j, fjern √òVRE og NEDRE formstation","Ops√¶tning: Monter ny formstation (√òVRE og NEDRE), luk og centr√©r v√¶rkt√∏j korrekt","K√∏ling: Tilslut k√∏leslanger, fjern overskydende slanger og h√¶ng dem op"]},
    3:{title:"Trin 3 ‚Äì Stanse Station (ikke relevant for BFS)",tasks:[]},
    4:{title:"Trin 4 ‚Äì Stabel Station",tasks:["Afmontering: L√∏sn stabelstation","Afmonter stabelstation","Ops√¶t ny stabelstation","Sp√¶nd","Just√©r bufferbord"]},
    5:{title:"Trin 5 ‚Äì Indl√¶s & Justering",tasks:["Inds√¶t folie og t√¶nd for opvarmningsfolie","Kontroll√©r at alle stationer er p√• plads","Indstil: varme i sl√¶de, k√∏leplade, afbl√¶sning og skab","Indl√¶s program og just√©r sp√¶nding","T√¶nd for vand","Sl√• start-automatik fra","T√¶nd PP-folie og start"]},
    6:{title:"Trin 6 ‚Äì Indk√∏ring",tasks:["Form og stans trinvist ‚Äì lav pr√∏vestans: Indstil startposition: 0,3‚Äì0,5 mm over sk√¶reh√∏jde (min. 0,5 mm ved nye knive)","K√∏r v√¶rkt√∏j manuelt eller med jog-funktion","Lav pr√∏vestans i folie efter hvert trin og inspic√©r emnet grundigt","Just√©r indtil resultatet er rent, uden grater eller fl√¶k","Ops√¶t og kalibr√©r stabelsektion (udskubber og stabelsk√•l/robot)","F√• formandens godkendelse og frigiv til produktion"]}
  }}
};

/* ---------- Utils ---------- */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const fmt=n=>String(n).padStart(2,'0');
const isoToLocal=iso=>iso?new Date(iso).toLocaleString():'‚Äì';
const uid=()=> 'tjek-'+Date.now()+'-'+Math.floor(Math.random()*1e6);
const nowISO=()=>new Date().toISOString();
const idMs=id=>{const m=/tjek-(\d+)-/.exec(id||'');return m?+m[1]:0};
const sortKey=s=>Date.parse(s.updatedAt||s.sentAt||0)||idMs(s.id)||0;
const statusText=$('#statusText'), statusDot=$('#statusDot');
function setStatus(text,color){ statusText.textContent=text; statusDot.style.background=color; }

/* ---------- Sessions ---------- */
const SKEY='omstilling.sessions.v3';
const AKEY='omstilling.activeId.v1';
function emptyPayload(templateKey='form_stanse_adskilt'){
  return {templateKey,meta:{operator:'',line:'',linenumber:'',order:'',toolno:'',approver:'',approveCheck:false},
          stamps:{stepStart:{1:null,2:null,3:null,4:null,5:null,6:null},inRunISO:null},tasks:{},comments:{general:''}};
}
const getSessions=()=>{try{return JSON.parse(localStorage.getItem(SKEY))||[]}catch(e){return[]}};
const saveSessions=s=>localStorage.setItem(SKEY,JSON.stringify(s));
const getActiveId=()=>localStorage.getItem(AKEY);
const setActiveId=id=>localStorage.setItem(AKEY,id);

/* F√∏rste k√∏rsel */
(function(){let s=getSessions(); if(s.length) return; const id=uid(), now=nowISO();
  s=[{id,title:'Tjekliste',sent:false,sentAt:null,createdAt:now,updatedAt:now,payload:emptyPayload('form_stanse_adskilt')}];
  saveSessions(s); setActiveId(id);
})();

/* ---------- Faner ---------- */
/* >>>>>>>>>>  KUN V√ÜRKT√òJSNR + LINJE i fanetitlen  <<<<<<<<<< */
function formatTabTitle(p){
  const lineRaw = (p.meta?.line || '').toString().trim();
  const toolRaw = (p.meta?.toolno || '').toString().trim();

  const parts = [];

  if (toolRaw) {
    const toolDisplay = /^vkt/i.test(toolRaw) ? toolRaw : `VKT ${toolRaw}`;
    parts.push(toolDisplay);
  }

  if (lineRaw) {
    const lineDisplay = /^\d+$/.test(lineRaw) ? `Linje ${lineRaw}` : lineRaw;
    parts.push(lineDisplay);
  }

  return parts.length ? parts.join(' ¬∑ ') : 'Tjekliste';
}

function renderTabs(){
  const tabsEl=$('#tabs');
  tabsEl.querySelectorAll('.tab[data-id], .tab-more').forEach(n=>n.remove());
  const sessions=getSessions(), activeId=getActiveId();
  const sorted=[...sessions].sort((a,b)=>sortKey(b)-sortKey(a));
  let visible=sorted.slice(0,3);
  const active=sessions.find(x=>x.id===activeId);
  if(active && !visible.some(v=>v.id===active.id)) visible=[active,...visible].slice(0,3);

  visible.forEach(s=>{
    const p=s.payload||emptyPayload();
    const el=document.createElement('div');
    el.className='tab'+(s.sent?' sent':''); el.setAttribute('data-id',s.id);
    el.setAttribute('role','tab'); el.tabIndex=0; el.setAttribute('aria-selected', s.id===activeId?'true':'false');
    el.innerHTML=`
      <div class="row">
        <span class="dot" style="width:8px;height:8px;border-radius:999px;background:${s.sent?'var(--success)':'var(--accent)'}"></span>
        <span class="title">${formatTabTitle(p)}</span>
        <span class="badgeAct">Aktiv</span>
        <button type="button" class="close" title="${s.sent?'Slet':'Slet kladde'}">${s.sent?'‚úñ':'üóëÔ∏é'}</button>
      </div>
      <div class="meta">${(TEMPLATES[p.templateKey]||{}).name || 'Skabelon'} ‚Ä¢ <span class="state">${s.sent?'√Öben (sendt)':'√Öben'}</span></div>
    `;
    el.querySelector('.close').addEventListener('click',(e)=>{
      e.stopPropagation();
      if(!confirm(s.sent?'Slet sendt tjekliste?':'Slet kladde?')) return;
      const list=getSessions().filter(x=>x.id!==s.id);
      saveSessions(list);
      const next=(list.find(x=>x.id===activeId)?activeId:(list[0]?.id));
      if(next) setActiveId(next);
      renderTabs(); loadActiveIntoForm(); renderHistory();
    });
    el.addEventListener('click',()=>{ if(s.id!==getActiveId()){ autoSaveSession(); setActiveId(s.id); renderTabs(); loadActiveIntoForm(); } setView('main'); });
    el.addEventListener('keydown',ev=>{ if(ev.key==='Enter'||ev.key===' '){ev.preventDefault(); el.click();}});
    tabsEl.insertBefore(el,$('#addTab'));
  });

  const hidden=sessions.length-visible.length;
  if(hidden>0){
    const more=document.createElement('div');
    more.className='tab-more'; more.textContent=`‚ãØ ${hidden} flere`; more.setAttribute('role','button'); more.tabIndex=0;
    more.addEventListener('click',()=>setView('hist'));
    tabsEl.insertBefore(more,$('#addTab'));
  }
}
document.getElementById('tabs').addEventListener('click',(e)=>{
  const tab=e.target.closest('.tab[data-id]'); if(tab){ autoSaveSession(); setActiveId(tab.getAttribute('data-id')); renderTabs(); loadActiveIntoForm(); setView('main'); }
});
$('#addTab').addEventListener('click',()=>openTemplateChooser((tmplKey)=>{
  autoSaveSession(); const list=getSessions(); const id=uid(); const now=nowISO();
  list.push({id,title:'Tjekliste',sent:false,sentAt:null,createdAt:now,updatedAt:now,payload:emptyPayload(tmplKey)});
  saveSessions(list); setActiveId(id); renderTabs(); resetForm(); loadActiveIntoForm(); renderHistory();
}));

/* ---------- Tema + Print ---------- */
(function(){
  const btn = document.getElementById('themeToggle');
  function setTheme(mode){
    if(mode==='light'){ document.body.setAttribute('data-theme','light'); localStorage.setItem('omstilling.theme','light'); }
    else { document.body.removeAttribute('data-theme'); localStorage.setItem('omstilling.theme','dark'); }
    btn.textContent = (document.body.getAttribute('data-theme')==='light') ? 'üåô M√∏rk' : '‚òÄÔ∏è Lys';
  }
  setTheme(localStorage.getItem('omstilling.theme')||'dark');
  btn.addEventListener('click',()=>setTheme(document.body.getAttribute('data-theme')==='light'?'dark':'light'));
  document.getElementById('printBtn').addEventListener('click',()=>window.print());
})();

/* ---------- BFS renummering UI ---------- */
let DISPLAY_MAP={1:1,2:2,3:3,4:4,5:5,6:6};
let DISPLAY_ORDER=[1,2,3,4,5,6];
function recomputeDisplayMapping(tmpl){
  const hidden=new Set(tmpl.hideSteps||[]); DISPLAY_MAP={}; DISPLAY_ORDER=[]; let disp=0;
  for(let n=1;n<=6;n++){ const st=tmpl.steps[n]||{tasks:[]}; const hide=hidden.has(n)||(st.tasks.length===0); if(hide) continue; disp++; DISPLAY_MAP[n]=disp; DISPLAY_ORDER.push(n); }
}
function updateTimeLabels(){
  const A=DISPLAY_ORDER; const pairs=[[A[0],A[1]],[A[1],A[2]],[A[2],A[3]],[A[3],A[4]]];
  const ids=['lbl12','lbl23','lbl34','lbl45'];
  pairs.forEach((p,i)=>{ const a=p?.[0],b=p?.[1]; const txt=(a&&b)?`Trin ${DISPLAY_MAP[a]} ‚Üí ${DISPLAY_MAP[b]}`:'‚Äî'; const el=document.getElementById(ids[i]); if(el) el.textContent=txt; });
  const firstDisp = DISPLAY_MAP[ DISPLAY_ORDER[0] ] || 1;
  $('#lblTot').textContent=`Start (Trin ${firstDisp}) ‚Üí I DRIFT`;
}
function buildTasksFromTemplate(tmplKey,payload){
  const tmpl=TEMPLATES[tmplKey]||TEMPLATES['form_stanse_adskilt']; recomputeDisplayMapping(tmpl);
  for(let n=1;n<=6;n++){
    const step=tmpl.steps[n]||{title:`Trin ${n}`,tasks:[]};
    const card=document.querySelector(`[data-stepcard="${n}"]`);
    const titleEl=document.querySelector(`.stepTitle[data-st="${n}"]`);
    const hide=(tmpl.hideSteps||[]).includes(n)||(step.tasks.length===0);
    card.style.display=hide?'none':'block';
    const dsp=DISPLAY_MAP[n]??n; titleEl.textContent=step.title.replace(/^Trin\s*\d+/, 'Trin '+dsp);
    const root=document.getElementById(`tasks-${n}`); root.innerHTML='';
    step.tasks.forEach((txt,idx)=>{
      const key=`t${n}_${idx+1}`; const iso=payload?.tasks?.[key]||null;
      const div=document.createElement('div'); div.className='task'+(iso?' done':'');
      div.innerHTML=`<input type="checkbox" data-t="${key}" ${iso?'checked':''} /><div class="txt">${txt}</div><span class="ts" id="ts_${key}" ${iso?`data-iso="${iso}"`:''}>${iso?isoToLocal(iso):'‚Äì'}</span>`;
      root.appendChild(div);
    });
  }
  TOTAL_TASKS=$$('input[type="checkbox"][data-t]').length;
  updateTimeLabels(); updateProgress();
}

/* ---------- State & events ---------- */
const stepStart={1:null,2:null,3:null,4:null,5:null,6:null}; let inRunISO=null, showOnlyOpen=false, TOTAL_TASKS=0;
const progBar=$('#progBar'), progText=$('#progText');
function updateProgress(){ const all=$$('input[type="checkbox"][data-t]'); const done=all.filter(cb=>cb.checked).length; const total=all.length; const pct=total?Math.round(done*100/total):0; progBar.style.width=pct+'%'; progText.textContent=`${done} / ${total} f√¶rdige`; }

document.addEventListener('change',(e)=>{
  if(!e.target.matches('input[type="checkbox"][data-t]')) return;
  const cb=e.target, id='ts_'+cb.getAttribute('data-t'), el=document.getElementById(id);
  if(cb.checked){ const iso=new Date().toISOString(); el.textContent=isoToLocal(iso); el.dataset.iso=iso; } else { el.textContent='‚Äì'; delete el.dataset.iso; }
  cb.closest('.task').classList.toggle('done',cb.checked); computeTimes(); updateProgress(); autoSaveSession(); renderHistory();
});
document.addEventListener('click',(e)=>{
  const b=e.target.closest('[data-stamp-btn]'); if(!b) return;
  const n=+b.getAttribute('data-stamp-btn'); const iso=new Date().toISOString();
  stepStart[n]=iso; $('#t'+n+'Start').textContent=isoToLocal(iso); if(n===1) setStatus('I gang','#f59e0b'); computeTimes(); updateProgress(); autoSaveSession(); renderHistory();
});
$('#btnInRun').addEventListener('click',()=>{
  const all=$$('input[type="checkbox"][data-t]').every(cb=>cb.checked);
  const ok=($('#approver')?.value||'').trim().length>0 && $('#approveCheck').checked;
  if(!all) return toast('error','Alle tjekpunkter i Trin 1‚Äì6 skal v√¶re markeret f√∏r I DRIFT.');
  if(!ok)  return toast('error','Udfyld Godkender og s√¶t bekr√¶ftelse.');
  inRunISO=new Date().toISOString(); $('#tInRun').textContent=isoToLocal(inRunISO); setStatus('I drift','#22c55e'); computeTimes(); updateProgress(); autoSaveSession(); renderHistory();
});
$('#toggleDone').addEventListener('click',()=>{
  showOnlyOpen=!showOnlyOpen;
  $$('.task').forEach(t=>{ const cb=t.querySelector('input[type="checkbox"][data-t]'); t.classList.toggle('done',cb.checked); t.style.display=(showOnlyOpen&&cb.checked)?'none':'flex'; });
  $('#toggleDone').textContent=showOnlyOpen?'Vis alle':'Vis kun √•bne';
});
function diff(a,b){ if(!a||!b) return 0; return Math.max(0,Math.floor((new Date(b)-new Date(a))/1000)); }
function fmtHMS(s){ const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60; return `${fmt(h)}:${fmt(m)}:${fmt(ss)}`; }
function computeTimes(){
  const ord=DISPLAY_ORDER.length?DISPLAY_ORDER:[1,2,3,4,5,6];
  const pairs=[[ord[0],ord[1]],[ord[1],ord[2]],[ord[2],ord[3]],[ord[3],ord[4]]];
  ['r12','r23','r34','r45'].forEach((id,i)=>{ const a=pairs[i]?.[0], b=pairs[i]?.[1]; document.getElementById(id).textContent=fmtHMS(diff(stepStart[a],stepStart[b])); });
  let total=inRunISO; for(let i=ord.length-1;i>=0 && !total;i--){ const s=stepStart[ord[i]]; if(s) total=s; }
  const start=stepStart[ord[0]]; $('#rTotal').textContent=fmtHMS(diff(start,total));
}

/* ---------- Collect / Apply ---------- */
function collect(){
  const tasks={}; $$('.task .ts').forEach(el=>{ if(el.id.startsWith('ts_')) tasks[el.id.replace('ts_','')]=el.dataset.iso||null; });
  return {templateKey:$('#tmplSelect').value||'form_stanse_adskilt',
          meta:{
            operator:($('#operator').value||'').trim(),
            line:($('#line').value||'').trim(),
            linenumber:($('#varenr').value||'').trim(),  // VARE NR. -> linenumber (payload)
            order:($('#order').value||'').trim(),
            toolno:($('#toolno').value||'').trim(),
            approver:($('#approver').value||'').trim(),
            approveCheck:$('#approveCheck').checked
          },
          stamps:{stepStart:{...stepStart},inRunISO},
          tasks,
          comments:{general:$('#generalComment')?.value||''}};
}
function resetForm(){
  $('#form').reset(); for(let k=1;k<=6;k++){ stepStart[k]=null; $('#t'+k+'Start').textContent='‚Äì'; }
  inRunISO=null; $('#tInRun').textContent='‚Äì'; $$('.tasks').forEach(el=>el.innerHTML='');
  $('#toggleDone').textContent='Vis kun √•bne'; showOnlyOpen=false; computeTimes(); updateProgress(); setStatus('Klar','#64748b');
}
function applyPayload(p){
  const sel=$('#tmplSelect'); sel.innerHTML=''; Object.entries(TEMPLATES).forEach(([k,v])=>{const o=document.createElement('option');o.value=k;o.textContent=v.name;sel.appendChild(o);});
  sel.value=p.templateKey||'form_stanse_adskilt';
  $('#operator').value=p.meta?.operator||''; $('#line').value=p.meta?.line||''; $('#varenr').value=p.meta?.linenumber||''; $('#order').value=p.meta?.order||''; $('#toolno').value=p.meta?.toolno||'';
  $('#approver').value=p.meta?.approver||''; $('#approveCheck').checked=!!p.meta?.approveCheck;
  for(let k=1;k<=6;k++){ stepStart[k]=p.stamps?.stepStart?.[k]||null; $('#t'+k+'Start').textContent=stepStart[k]?isoToLocal(stepStart[k]):'‚Äì'; }
  inRunISO=p.stamps?.inRunISO||null; $('#tInRun').textContent=inRunISO?isoToLocal(inRunISO):'‚Äì'; if(inRunISO) setStatus('I drift','#22c55e');
  buildTasksFromTemplate(sel.value,p); $('#generalComment').value=p.comments?.general||''; computeTimes(); updateProgress();
}
$('#tmplSelect').addEventListener('change',()=>{
  if(!confirm('Skifte skabelon for denne tjekliste?')){ const id=getActiveId(); const s=getSessions().find(x=>x.id===id); $('#tmplSelect').value=s?.payload?.templateKey||'form_stanse_adskilt'; return; }
  const cur=collect(); cur.templateKey=$('#tmplSelect').value; buildTasksFromTemplate(cur.templateKey,cur); autoSaveSession(); renderTabs(); renderHistory();
});

/* ---------- Knapper nederst ---------- */
$('#saveDraft').addEventListener('click',()=>{ autoSaveSession(); toast('ok','Kladde gemt.'); renderHistory(); });
$('#clearBtn').addEventListener('click',()=>{ if(!confirm('Ryd kun den aktive tjekliste?'))return; resetForm(); autoSaveSession(); toast('ok','Tjekliste nulstillet.'); renderHistory(); });
$('#form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const activeId=getActiveId(); const list=getSessions(); const idx=list.findIndex(x=>x.id===activeId); if(idx<0) return;
  if(!$('#operator').value || !$('#line').value) return toast('error','Udfyld Omstiller og Linje.');
  const payload=collect();
  try{
    const use=typeof window.OMSTILLING_ENDPOINT==='string' && window.OMSTILLING_ENDPOINT.length>10;
    if(use){
      const res=await fetch(window.OMSTILLING_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('HTTP '+res.status);
      toast('ok','Indsendt til flow.'); list[idx].payload=payload; list[idx].sent=true; list[idx].sentAt=nowISO(); list[idx].updatedAt=list[idx].sentAt;
      saveSessions(list); renderTabs(); setReadOnly(true); setStatus('Klar','#64748b'); updateProgress(); renderHistory();
    }else{
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`omstilling-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click(); URL.revokeObjectURL(url);
      toast('ok','Downloadede data som .json'); list[idx].payload=payload; list[idx].updatedAt=nowISO(); saveSessions(list); renderHistory();
    }
  }catch(err){ console.error(err); toast('error','Kunne ikke indsende.'); }
});
function autoSaveSession(){ const id=getActiveId(); if(!id) return; const list=getSessions(); const idx=list.findIndex(x=>x.id===id); if(idx<0) return; list[idx].payload=collect(); list[idx].updatedAt=nowISO(); saveSessions(list); renderTabs(); }
function setReadOnly(sent){ const dis=!!sent; $$('input,select,textarea,button').forEach(el=>{ if(['themeToggle','printBtn'].includes(el.id))return; if(el.closest('.tabs'))return; if(el.classList.contains('close'))return; if(el.id==='addTab')return; el.disabled=dis; }); }

/* ---------- Historik ---------- */
const STEP_NAMES_DEFAULT={1:'Forberedelse',2:'Form Station',3:'Stanse Station',4:'Stabel Station',5:'Indl√¶s & Justering',6:'Indk√∏ring'};
function sessionStatus(p){ if(p.stamps?.inRunISO) return {txt:'I drift',dot:'var(--success)'}; const any=Object.values(p.stamps?.stepStart||{}).some(Boolean); if(any) return {txt:'I gang',dot:'var(--warn)'}; return {txt:'Klar',dot:'#64748b'}; }
function currentStep(p){
  const starts=p.stamps?.stepStart||{}; let n=0; Object.keys(starts).forEach(k=>{ if(starts[k]) n=Math.max(n,+k); });
  if(!n){ Object.keys(p.tasks||{}).forEach(k=>{ const m=/^t(\d+)_/.exec(k); if(m) n=Math.max(n,+m[1]); }); }
  n=Math.max(1,Math.min(6,n||1)); const tmpl=TEMPLATES[p.templateKey||'form_stanse_adskilt']; const title=tmpl?.steps?.[n]?.title || `Trin ${n} ‚Äî ${STEP_NAMES_DEFAULT[n]}`;
  const hidden=new Set(tmpl.hideSteps||[]); let disp=0,dnum=1; for(let i=1;i<=6;i++){ const st=tmpl.steps[i]||{tasks:[]}; const hide=hidden.has(i)||(st.tasks.length===0); if(!hide){ disp++; if(i===n){ dnum=disp; break; } } }
  return {num:dnum, name:title.replace(/^Trin \d+\s*‚Äì?\s*/,'')};
}
function progressOf(p){ const done=Object.values(p.tasks||{}).filter(Boolean).length; const tmpl=TEMPLATES[p.templateKey||'form_stanse_adskilt']; const total=Object.values(tmpl.steps).reduce((a,s)=>a+(s.tasks?.length||0),0); const pct=total?Math.round(done*100/total):0; return {done,total,pct}; }
function renderHistory(){
  const body=$('#histBody'), empty=$('#histEmpty'); const rows=getSessions().filter(s=>!s.sent);
  if(!rows.length){ body.innerHTML=''; empty.style.display='block'; return; } empty.style.display='none';
  let html=''; rows.sort((a,b)=>sortKey(b)-sortKey(a)).forEach(s=>{
    const p=s.payload||emptyPayload(); const st=sessionStatus(p), step=currentStep(p), prog=progressOf(p);
    html+=`<tr><td><span class="chip"><span class="dot" style="background:${st.dot}"></span>${st.txt}</span></td>
           <td><span class="pill">Trin ${step.num} ‚Äî ${step.name}</span></td>
           <td style="min-width:200px"><div class="miniBar"><span style="width:${prog.pct}%"></span></div><div class="note">${prog.done} / ${prog.total} (${prog.pct}%)</div></td>
           <td>${p.meta?.operator||'‚Äì'}</td><td>${/^\d+$/.test(p.meta?.line||'')?'Linje '+p.meta.line:(p.meta?.line||'‚Äì')}</td><td>${p.meta?.order||'‚Äì'}</td>
           <td><button class="btn secondary" data-open="${s.id}">√Öbn</button></td></tr>`;
  });
  body.innerHTML=html; body.querySelectorAll('button[data-open]').forEach(b=>{ b.onclick=()=>{ autoSaveSession(); setActiveId(b.getAttribute('data-open')); renderTabs(); loadActiveIntoForm(); setView('main'); }; });
}

/* ---------- Template modal ---------- */
function openTemplateChooser(onPick){
  const modal=$('#templateModal'), row=$('#tmplBtns'); row.innerHTML='';
  Object.entries(TEMPLATES).forEach(([k,v])=>{ const b=document.createElement('button'); b.className='tmplBtn'; b.type='button';
    const total=Object.values(v.steps).reduce((a,s)=>a+(s.tasks?.length||0),0);
    b.innerHTML=`<strong>${v.name}</strong><div class="note">${total} punkter ‚Ä¢ kanoniske 6 trin</div>`; b.onclick=()=>{ modal.hidden=true; onPick(k); };
    row.appendChild(b);
  });
  $('#tmplCancel').onclick=()=>{ modal.hidden=true; }; modal.hidden=false;
}

/* ---------- Toast ---------- */
function toast(kind,msg){
  const fb=$('#feedback'); const d=document.createElement('div'); d.style.marginTop='10px'; d.style.padding='12px'; d.style.borderRadius='12px';
  d.style.background = kind==='ok' ? '#052e1c' : '#3b0a0a'; d.style.color = kind==='ok' ? '#86efac' : '#fecaca'; d.style.border = '1px solid ' + (kind==='ok' ? '#0a7a41' : '#7f1d1d');
  d.textContent=msg; fb.innerHTML=''; fb.appendChild(d); setTimeout(()=>{ if(fb.contains(d)) fb.removeChild(d); },6000);
}

/* ---------- View & init ---------- */
function setView(which){ if(which==='hist'){ $('#view-main').style.display='none'; $('#view-hist').style.display='block'; $('#navMain').classList.remove('active'); $('#navHist').classList.add('active'); renderHistory(); } else { $('#view-main').style.display='block'; $('#view-hist').style.display='none'; $('#navMain').classList.add('active'); $('#navHist').classList.remove('active'); } }
$('#navMain').onclick=()=>setView('main'); $('#navHist').onclick=()=>setView('hist');

(function init(){
  const sel=$('#tmplSelect'); sel.innerHTML=''; Object.entries(TEMPLATES).forEach(([k,v])=>{const o=document.createElement('option'); o.value=k; o.textContent=v.name; sel.appendChild(o);});
  const saved=localStorage.getItem('omstilling.theme')||'dark'; if(saved==='light') document.body.setAttribute('data-theme','light');
  renderTabs(); loadActiveIntoForm(); updateProgress(); renderHistory();
  window.onerror=(msg,src,line,col,err)=>{ alert('JavaScript-fejl: '+msg+' (linje '+line+')'); console.error(err||msg); return false; };
})();
function loadActiveIntoForm(){
  const id=getActiveId(), list=getSessions(), s=list.find(x=>x.id===id)||list[0];
  if(!s){ const nId=uid(), now=nowISO(); list.push({id:nId,title:'Tjekliste',sent:false,sentAt:null,createdAt:now,updatedAt:now,payload:emptyPayload('form_stanse_adskilt')}); saveSessions(list); setActiveId(nId); renderTabs(); return loadActiveIntoForm(); }
  resetForm(); applyPayload(s.payload||emptyPayload('form_stanse_adskilt')); setReadOnly(s.sent);
}
</script>
</body>
</html>
